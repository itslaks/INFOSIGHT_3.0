<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberSentry AI</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.1.0/fonts/remixicon.css" rel="stylesheet"/>
    
    <style>
        /* === CYBER NOIR THEME === */
        :root {
            --bg-void: #0a0e12;
            --bg-deep: #0f1419;
            --bg-surface: #151b23;
            --bg-elevated: #1a2129;
            
            /* SCI-FI NEON COLORS */
            --neon-blue: #00f0ff;
            --neon-purple: #b026ff;
            --cyber-pink: #ff006e;
            
            --accent-primary: #00f0ff; /* Cyan neon */
            --accent-primary-dim: rgba(0, 240, 255, 0.12);
            --accent-primary-glow: rgba(0, 240, 255, 0.3);
            
            --accent-secondary: #ff006e; /* Hot pink */
            --accent-tertiary: #b026ff; /* Purple */

            /* SOURCE COLORS */
            --cloud-llm: #ff006e;
            --cloud-llm-dim: rgba(255, 0, 110, 0.12);
            --cloud-llm-glow: rgba(255, 0, 110, 0.3);
            
            --local-llm: #b026ff;
            --local-llm-dim: rgba(176, 38, 255, 0.12);
            --local-llm-glow: rgba(176, 38, 255, 0.3);
            
            --json-source: #00f0ff;
            --json-source-dim: rgba(0, 240, 255, 0.12);
            --json-source-glow: rgba(0, 240, 255, 0.3);

            /* Professional Typography Scale */
            --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
            
            /* Readable Font Sizes */
            --text-xs: 0.6875rem;      /* 11px - Labels, timestamps */
            --text-sm: 0.8125rem;      /* 13px - Secondary text */
            --text-base: 0.9375rem;    /* 15px - Body text */
            --text-md: 1.0625rem;      /* 17px - Emphasis */
            --text-lg: 1.25rem;        /* 20px - Section headers */
            --text-xl: 1.5rem;         /* 24px - Page titles */
            --text-2xl: 2rem;          /* 32px - Hero text */
            
            /* Line Heights */
            --leading-tight: 1.25;
            --leading-normal: 1.6;
            --leading-relaxed: 1.8;
            
            /* Letter Spacing */
            --tracking-tight: -0.02em;
            --tracking-normal: 0;
            --tracking-wide: 0.025em;
            --tracking-wider: 0.05em;
            
            --text-primary: #e8edf3;
            --text-secondary: #a0aab8;
            --text-tertiary: #6b7280;
            
            --border-subtle: rgba(255, 255, 255, 0.05);
            --border-strong: rgba(0, 240, 255, 0.2);
            
            /* Reduced Glow Effects */
            --glow-subtle: 0 0 10px rgba(0, 240, 255, 0.15);
            --glow-medium: 0 0 15px rgba(0, 240, 255, 0.25);
            --glow-strong: 0 0 20px rgba(0, 240, 255, 0.3);
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--bg-void);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }
        
        /* Typography Pairing */
        code,
        pre,
        .message-text code {
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(0, 240, 255, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(176, 38, 255, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            grid-template-rows: 70px 1fr;
            height: 100vh;
        }
        
        .app-container.sidebar-collapsed {
            grid-template-columns: 0 1fr;
        }
        
        /* === SIDEBAR === */
        .sidebar {
            background: rgba(15, 20, 25, 0.98);
            backdrop-filter: blur(20px);
            border-right: 2px solid rgba(0, 240, 255, 0.2);
            box-shadow: 4px 0 30px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: var(--transition);
            grid-row: 1 / 3; /* Span both rows */
        }
        
        .sidebar-collapsed .sidebar {
            transform: translateX(-100%);
        }
        
        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .sidebar-header h3 {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .new-chat-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-tertiary));
            border: none;
            color: var(--bg-void);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
            transition: var(--transition);
        }
        
        .new-chat-btn:hover {
            transform: scale(1.05);
            box-shadow: var(--glow-strong);
        }
        
        .sidebar-search {
            padding: 0.75rem;
            border-bottom: 1px solid rgba(0, 240, 255, 0.1);
        }

        .search-container {
            display: flex;
            align-items: center;
            background: rgba(10, 14, 18, 0.6);
            border: 1px solid rgba(0, 240, 255, 0.15);
            border-radius: 6px;
            padding: 0.625rem 0.875rem;
            transition: all 0.2s ease;
        }

        .search-container:focus-within {
            background: rgba(10, 14, 18, 0.8);
            border-color: rgba(0, 240, 255, 0.3);
        }

        .sidebar-search i {
            color: rgba(0, 240, 255, 0.6);
            font-size: 0.9375rem;
            margin-right: 0.625rem;
        }

        .sidebar-search input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: var(--text-sm);
            outline: none;
            font-family: var(--font-primary);
        }

        .sidebar-search input::placeholder {
            color: rgba(160, 170, 184, 0.4);
        }
        
        .conversation-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        .conversation-item {
            padding: 0.75rem 1rem;
            margin-bottom: 0.25rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid transparent;
        }
        
        .conversation-item:hover {
            background: var(--bg-elevated);
            border-color: var(--border-subtle);
        }
        
        .conversation-item.active {
            background: var(--bg-elevated);
            border-color: var(--accent-primary);
        }
        
        .conversation-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .conversation-meta {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .sidebar-btn {
            padding: 0.75rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: var(--transition);
        }
        
        .sidebar-btn:hover {
            background: var(--bg-surface);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }
        
        .sidebar-btn i {
            font-size: 1.125rem;
        }
        
        .sidebar-toggle {
            position: fixed;
            top: 1rem;
            left: 1rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            color: var(--accent-primary);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
            z-index: 1000;
            transition: var(--transition);
        }
        
        .sidebar-toggle:hover {
            background: var(--bg-surface);
            box-shadow: var(--glow-strong);
        }
        
        .sidebar-collapsed .sidebar-toggle {
            display: flex;
        }
        
        .sidebar-collapsed .sidebar-toggle i::before {
            content: '\ee4a';
        }

        .app-container {
            position: relative;
            z-index: 1;
        }

        .header {
            background: linear-gradient(180deg, 
                rgba(15, 20, 25, 0.98) 0%, 
                rgba(21, 27, 35, 0.98) 100%);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 240, 255, 0.15);
            padding: 12px 24px;
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 1.5rem;
            z-index: 100;
            grid-column: 2;
            grid-row: 1;
            height: auto;
            min-height: 52px;
            font-size: 13px;
            letter-spacing: 0.3px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            background: rgba(0, 240, 255, 0.1);
            border: 1px solid rgba(0, 240, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .logo-icon img {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }

        .logo-text {
            font-size: var(--text-md);
            font-weight: 700;
            color: #00f0ff;
            letter-spacing: var(--tracking-wide);
            text-transform: uppercase;
            font-family: var(--font-primary);
        }

        /* System Status Center Section */
        .system-status {
            display: flex;
            align-items: center;
            gap: 2rem;
            justify-content: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: var(--text-xs);
            color: var(--text-tertiary);
            font-family: var(--font-mono);
            text-transform: uppercase;
            letter-spacing: var(--tracking-wider);
        }

        .status-item-label {
            color: var(--text-tertiary);
        }

        .status-item-value {
            color: #00f0ff;
            font-weight: 600;
        }

        .status-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #00f0ff;
            box-shadow: 0 0 8px rgba(0, 240, 255, 0.6);
        }

        .status-indicator.active {
            animation: pulse 2s ease-in-out infinite;
        }

        .status-indicator.warning {
            background: #ffa500;
            box-shadow: 0 0 8px rgba(255, 165, 0, 0.6);
        }

        /* Right Section */
        .header-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: rgba(21, 27, 35, 0.8);
            border: 1px solid rgba(0, 240, 255, 0.2);
            color: #00f0ff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background: rgba(0, 240, 255, 0.1);
            border-color: #00f0ff;
        }
        
        body.light-mode {
            --bg-void: #f8f9fa;
            --bg-deep: #ffffff;
            --bg-surface: #f1f3f5;
            --bg-elevated: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #495057;
            --text-tertiary: #6c757d;
            --border-subtle: rgba(0, 0, 0, 0.1);
        }
        
        body.light-mode .theme-toggle i::before {
            content: '\f166';
        }


        /* Sci-Fi Scan Line Effect */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 10% 20%, rgba(0, 240, 255, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 90% 80%, rgba(176, 38, 255, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(255, 0, 110, 0.03) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
            animation: bgPulse 10s ease-in-out infinite;
        }

        @keyframes bgPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .app-container::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 240, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 240, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 0;
            opacity: 0.3;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 1.25rem;
            background: linear-gradient(135deg, 
                rgba(0, 240, 255, 0.05), 
                rgba(176, 38, 255, 0.05));
            border: 2px solid transparent;
            border-radius: 100px;
            font-size: 0.875rem;
            font-weight: 600;
            color: #00f0ff;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .status-badge::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 100px;
            padding: 2px;
            background: linear-gradient(135deg, #00f0ff, #b026ff);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, 
                          linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, 
                  linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            animation: rotateBorder 3s linear infinite;
        }

        @keyframes rotateBorder {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-badge::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 50%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(0, 240, 255, 0.1), 
                transparent);
            transform: translateY(-50%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #00f0ff;
            box-shadow: 0 0 15px #00f0ff,
                        0 0 30px rgba(0, 240, 255, 0.5),
                        inset 0 0 5px rgba(255, 255, 255, 0.5);
            animation: pulse 2s ease-in-out infinite;
            position: relative;
            z-index: 1;
        }

        .status-dot::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            border: 2px solid #00f0ff;
            opacity: 0;
            animation: ripple 2s infinite;
        }

        @keyframes ripple {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        .status-badge span {
            position: relative;
            z-index: 1;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 0 10px rgba(0, 240, 255, 0.5);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .model-info {
            font-size: 0.8125rem;
            color: var(--text-tertiary);
            font-family: 'JetBrains Mono', monospace;
            padding: 0.625rem 1.25rem;
            background: linear-gradient(135deg, 
                rgba(0, 240, 255, 0.05), 
                rgba(176, 38, 255, 0.05));
            border: 1px solid rgba(0, 240, 255, 0.2);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .model-info::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 3px;
            height: 100%;
            background: linear-gradient(180deg, #00f0ff, #b026ff);
            box-shadow: 0 0 10px rgba(0, 240, 255, 0.5);
        }

        .model-info::after {
            content: '●';
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #00f0ff;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        
        /* === CHAT CONTAINER === */
        .chat-container {
            grid-column: 2;
            grid-row: 2;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            max-width: 1800px;
            width: 100%;
            margin: 0 auto;
            padding: 0 3rem;
            height: calc(100vh - 60px);
        }

        .chat-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100px;
            background: linear-gradient(180deg, 
                rgba(10, 14, 18, 0.8) 0%, 
                transparent 100%);
            pointer-events: none;
            z-index: 1;
        }

        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 64px 64px;
            display: flex;
            flex-direction: column;
            gap: 56px; /* Vertical rhythm between messages/sections */
            position: relative;
            scroll-behavior: smooth;
        }
        
        /* Main content wrapper */
        .main-content {
            padding: 64px 64px;
        }
        
        /* Soft content mask at bottom - Fixed gradient */
        .messages-area::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 120px;
            background: linear-gradient(to bottom, 
                rgba(5, 7, 12, 0) 0%,
                rgba(5, 7, 12, 0.5) 50%,
                rgba(5, 7, 12, 1) 100%);
            pointer-events: none;
            z-index: 1;
        }
        
        /* Footer buffer */
        .footer-buffer {
            height: 80px;
        }
        
        /* Reading progress indicator */
        .read-progress {
            position: fixed;
            top: 0;
            left: 0;
            height: 2px;
            background: #00ffe1;
            width: 0%;
            z-index: 999;
            transition: width 0.1s ease;
        }
        
        /* Custom scrollbar theme */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(10, 14, 18, 0.5);
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #00ffe1, #00c0ff);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #00ffe1, #00d4ff);
        }
        
        /* Animated button interactions */
        .action-btn,
        .run-btn {
            transition: all 0.25s ease;
        }
        
        .action-btn:hover,
        .run-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 255, 255, 0.25);
        }

        .message {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
            background: rgba(0, 240, 255, 0.1);
            border: 1px solid rgba(0, 240, 255, 0.3);
        }

        .message-avatar.user {
            background: rgba(176, 38, 255, 0.1);
            border-color: rgba(176, 38, 255, 0.3);
        }

        .message-avatar i {
            color: #00f0ff;
        }

        .message-avatar.user i {
            color: #b026ff;
        }

        .message-sender {
            font-weight: 600;
            color: var(--text-primary);
            font-size: var(--text-sm);
            font-family: var(--font-mono);
            text-transform: uppercase;
            letter-spacing: var(--tracking-wide);
        }

        .message-time {
            font-size: var(--text-xs);
            color: var(--text-tertiary);
            font-family: var(--font-mono);
        }

        .message-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: var(--text-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: var(--tracking-wider);
            font-family: var(--font-mono);
        }

        .badge-json {
            background: rgba(0, 212, 170, 0.15);
            color: #00d4aa;
            border: 1px solid rgba(0, 212, 170, 0.3);
        }

        .badge-ai {
            background: rgba(0, 240, 255, 0.15);
            color: #00f0ff;
            border: 1px solid rgba(0, 240, 255, 0.3);
        }

        /* Security Report Card Design / Vertical Rhythm Cards */
        .message-content {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            padding: 28px;
            margin-left: 40px;
            position: relative;
            overflow: hidden;
            margin-bottom: 48px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 0 0 1px rgba(0, 255, 255, 0.12), 0 0 24px rgba(0, 255, 255, 0.08);
            transition: opacity 0.4s ease;
        }
        
        .message-content:hover {
            opacity: 1;
        }
        
        .message-content:not(:hover) {
            opacity: 0.88;
        }
        
        /* Cyber Card - Documentation-style container */
        .cyber-card {
            max-width: 1400px;
            margin: 0 auto 40px auto;
            box-shadow: 0 0 0 1px rgba(0, 255, 255, 0.12), 0 0 24px rgba(0, 255, 255, 0.08);
            transition: opacity 0.4s ease;
            position: relative;
        }
        
        .cyber-card:hover {
            opacity: 1;
        }
        
        .cyber-card:not(:hover) {
            opacity: 0.88;
        }
        
        /* Subtle Parallax Glow - Fixed gradient */
        .cyber-card::after {
            content: "";
            position: absolute;
            inset: -2px;
            background: linear-gradient(120deg, 
                rgba(0, 255, 225, 0.08) 0%,
                rgba(155, 92, 255, 0.08) 50%,
                rgba(0, 255, 225, 0) 100%);
            opacity: 1;
            border-radius: 12px;
            pointer-events: none;
            z-index: -1;
        }
        
        /* Reading Mode */
        .reading-mode .cyber-card {
            max-width: 1320px;
            line-height: 1.9;
            background: rgba(15, 18, 26, 0.96);
        }
        
        .reading-mode .message-content {
            max-width: 1320px;
            line-height: 1.9;
            background: rgba(15, 18, 26, 0.96);
        }
        
        /* Dynamic Content Density Switch */
        .density-compact p {
            line-height: 1.55;
        }
        
        .density-comfortable p {
            line-height: 1.75;
        }
        
        .density-spacious p {
            line-height: 1.9;
        }
        
        /* Section Summary Boxes */
        .section-summary {
            background: rgba(0, 255, 255, 0.04);
            border-left: 4px solid #00ffe1;
            padding: 18px;
            margin: 32px 0;
            border-radius: 8px;
        }
        
        /* Verified Advisory Badge */
        .verified-badge {
            background: #00ffe1;
            color: #001;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .verified-badge::before {
            content: "✓";
            font-size: 12px;
        }
        
        /* Section Jump Navigator - Smooth scrolling */
        .section-nav {
            position: fixed;
            right: 32px;
            top: 120px;
            opacity: 0.8;
            background: rgba(15, 20, 25, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 12px;
            padding: 16px;
            min-width: 200px;
            max-height: 60vh;
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 100;
            transition: opacity 0.3s ease, transform 0.3s ease;
            scroll-behavior: smooth;
        }
        
        .section-nav:hover {
            opacity: 1;
            transform: translateX(-2px);
        }
        
        /* Smooth scrollbar for Quick Jump */
        .section-nav::-webkit-scrollbar {
            width: 6px;
        }
        
        .section-nav::-webkit-scrollbar-track {
            background: rgba(10, 14, 18, 0.3);
            border-radius: 10px;
        }
        
        .section-nav::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, rgba(0, 255, 225, 0.4), rgba(0, 192, 255, 0.4));
            border-radius: 10px;
            transition: background 0.2s ease;
        }
        
        .section-nav::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, rgba(0, 255, 225, 0.6), rgba(0, 192, 255, 0.6));
        }
        
        .section-nav-title {
            font-size: 12px;
            font-weight: 700;
            color: #00ffe1;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(0, 255, 255, 0.2);
        }
        
        .section-nav-item {
            display: block;
            padding: 8px 12px;
            color: var(--text-secondary);
            font-size: 13px;
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 4px;
            position: relative;
            overflow: hidden;
        }
        
        .section-nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: #00ffe1;
            transform: scaleY(0);
            transition: transform 0.25s ease;
        }
        
        .section-nav-item:hover {
            background: rgba(0, 255, 255, 0.1);
            color: #00ffe1;
            transform: translateX(4px);
            padding-left: 16px;
        }
        
        .section-nav-item:hover::before {
            transform: scaleY(1);
        }
        
        .section-nav-item.active {
            background: rgba(0, 255, 255, 0.15);
            color: #00ffe1;
            font-weight: 600;
            padding-left: 16px;
        }
        
        .section-nav-item.active::before {
            transform: scaleY(1);
        }
        
        /* Section spacing - Golden ratio */
        .section {
            margin-top: 72px;
            position: relative;
        }
        
        /* Smart Collapse Sections */
        .section.collapsed > *:not(h2) {
            display: none;
        }
        
        .section h2 {
            cursor: pointer;
            user-select: none;
        }
        
        .section h2::before {
            content: "▼ ";
            font-size: 0.7em;
            opacity: 0.6;
            transition: transform 0.3s ease;
        }
        
        .section.collapsed h2::before {
            content: "▶ ";
        }
        
        /* Paragraph spacing in cards */
        .message-content p,
        .cyber-card p {
            line-height: 1.75;
            margin-bottom: 18px;
        }
        
        /* Bullet spacing in cards */
        .message-content li,
        .cyber-card li {
            margin-bottom: 12px;
            line-height: 1.7;
        }
        
        /* Better bullet icons */
        .cyber-card ul {
            list-style: none;
            padding-left: 0;
        }
        
        .cyber-card li::before {
            content: "▸";
            color: #00ffe1;
            margin-right: 10px;
            font-weight: bold;
        }
        
        /* Section anchors */
        .section h2::after {
            content: " #";
            color: #00ffe1;
            opacity: 0.5;
            font-size: 14px;
            font-weight: normal;
        }
        
        /* Active section highlight */
        .section.active {
            box-shadow: 0 0 0 1px rgba(0, 255, 255, 0.25);
            border-radius: 8px;
            padding: 8px;
            margin: -8px;
        }
        
        /* Heading hierarchy */
        .message-content h1,
        .cyber-card h1 {
            font-size: 30px;
            margin-bottom: 22px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: 0.3px;
        }
        
        .message-content h2,
        .cyber-card h2 {
            font-size: 22px;
            margin: 42px 0 16px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: 0.4px;
        }
        
        /* First paragraph flow */
        .cyber-card > p:first-of-type {
            font-size: 16px;
            line-height: 1.8;
            color: rgba(255, 255, 255, 0.85);
        }
        
        .message-content h3,
        .cyber-card h3 {
            font-size: 18px;
            margin: 32px 0 12px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: 0.3px;
        }
        
        /* Divider lines - Fixed gradient */
        .divider {
            height: 1px;
            background: linear-gradient(to right, 
                rgba(0, 255, 225, 0) 0%,
                rgba(0, 255, 225, 0.4) 50%,
                rgba(0, 255, 225, 0) 100%);
            margin: 64px 0;
            border: none;
            opacity: 0.6;
        }
        
        /* Code box - Professional IDE embed style */
        .code-box,
        .message-content pre,
        .cyber-card pre {
            background: #0b0f16;
            border: 1px solid rgba(0, 255, 255, 0.15);
            border-radius: 14px;
            padding: 24px;
            margin: 32px 0 40px;
            overflow-x: auto;
            position: relative;
        }
        
        /* Copy button for code blocks */
        .code-copy-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 6px 12px;
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 6px;
            color: #00ffe1;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
            opacity: 0;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .code-box:hover .code-copy-btn,
        .message-content pre:hover .code-copy-btn,
        .cyber-card pre:hover .code-copy-btn {
            opacity: 1;
        }
        
        .code-copy-btn:hover {
            background: rgba(0, 255, 255, 0.2);
            border-color: #00ffe1;
            transform: translateY(-1px);
        }
        
        .code-copy-btn.copied {
            background: rgba(0, 212, 170, 0.2);
            border-color: #00d4aa;
            color: #00d4aa;
        }
        
        .code-box code,
        .message-content pre code,
        .cyber-card pre code {
            background: transparent;
            border: none;
            color: #e8edf3;
            padding: 0;
        }

        .message-content.user {
            background: rgba(26, 33, 41, 0.4);
            border-color: rgba(176, 38, 255, 0.15);
        }

        .message-content.ai {
            border-left: 3px solid #00f0ff;
        }

        /* Report Header */
        .report-header {
            padding: 40px 0 20px 0; /* Vertical rhythm for section headings */
            background: transparent;
            border-bottom: 1px solid rgba(0, 240, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        /* Sticky Section Header (Enterprise SOC Dashboard Feel) */
        .advisory-header,
        .report-header.sticky {
            position: sticky;
            top: 0;
            background: rgba(8, 12, 20, 0.95);
            backdrop-filter: blur(12px);
            z-index: 10;
            padding: 20px 0;
            margin: -20px 0 20px 0;
        }

        .report-title {
            font-size: 26px; /* Section Title */
            font-weight: 600;
            color: #00f0ff;
            font-family: var(--font-primary);
            letter-spacing: 0.4px;
        }

        .report-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: var(--text-xs);
            color: var(--text-tertiary);
            font-family: var(--font-mono);
        }

        /* Report Body */
        .report-body {
            padding: 16px 0 0 0; /* Paragraph spacing under headings */
        }

        .message-text {
            color: var(--text-primary);
            line-height: 1.7;
            font-size: 15px; /* Body text */
            font-family: var(--font-primary);
        }

        /* Security Data Blocks */
        .security-block {
            background: rgba(15, 20, 25, 0.6);
            border: 1px solid rgba(0, 240, 255, 0.15);
            border-radius: 6px;
            padding: 1rem;
            margin: 0.75rem 0;
        }

        .security-block-header {
            font-size: var(--text-sm);
            font-weight: 700;
            color: #00f0ff;
            margin-bottom: 0.75rem;
            font-family: var(--font-mono);
            text-transform: uppercase;
            letter-spacing: var(--tracking-wider);
        }

        .security-list {
            list-style: none;
            padding-left: 20px;
            margin: 12px 0 0 0;
            line-height: 1.7;
        }

        .security-list li {
            padding: 0;
            margin-bottom: 10px;
            font-size: var(--text-sm);
            color: var(--text-secondary);
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .security-list li:last-child {
            margin-bottom: 0;
        }

        .security-list li::before {
            content: '•';
            color: #00f0ff;
            font-weight: bold;
            flex-shrink: 0;
        }

        /* Code Blocks */
        .message-text code {
            background: rgba(0, 240, 255, 0.08);
            padding: 0.125rem 0.5rem;
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: var(--text-sm);
            color: #00f0ff;
            border: 1px solid rgba(0, 240, 255, 0.15);
            font-weight: 500;
        }

        .message-text pre {
            background: var(--bg-void);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: 1rem;
            overflow-x: auto;
            margin: 0.75rem 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8125rem;
        }

        .message-text pre code {
            background: transparent;
            padding: 0;
            color: var(--text-primary);
        }

        /* Global list spacing for readability */
        ul, ol {
            margin: 12px 0 0 20px;
            line-height: 1.7;
        }

        li {
            margin-bottom: 10px;
        }

        .message-actions,
        .card-actions {
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            padding-top: 24px;
            margin-top: 40px;
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 0.8125rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .action-btn:hover {
            background: var(--bg-surface);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .model-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.25rem 0.625rem;
            background: var(--bg-void);
            border: 1px solid var(--border-subtle);
            border-radius: 100px;
            font-size: 0.6875rem;
            color: var(--text-tertiary);
            font-family: 'JetBrains Mono', monospace;
            margin-left: 0.5rem;
        }

        .message-content {
            position: relative;
            overflow: hidden;
        }

        .message-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, 
                transparent, 
                var(--accent-primary), 
                transparent);
            animation: scan 3s ease-in-out infinite;
        }

        @keyframes scan {
            0%, 100% { left: -100%; }
            50% { left: 100%; }
        }

        /* === SUGGESTIONS === */
        .suggestions-panel {
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            margin-bottom: 1rem;
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .suggestions-panel.active {
            max-height: 300px;
            opacity: 1;
        }
        
        .suggestions-header {
            padding: 0.75rem 1rem;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--accent-primary);
        }
        
        .suggestions-list {
            max-height: 240px;
            overflow-y: auto;
        }
        
        .suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-item:hover {
            background: var(--bg-elevated);
        }
        
        .suggestion-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            background: var(--accent-primary-dim);
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }
        
        .suggestion-content {
            flex: 1;
        }
        
        .suggestion-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.125rem;
        }
        
        .suggestion-description {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        /* === INPUT AREA === */
        .input-area {
            padding: 1rem 0;
            background: rgba(15, 20, 25, 0.98);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0, 240, 255, 0.15);
        }

        .command-console {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        /* Mode Selector */
        .mode-selector {
            display: flex;
            gap: 0.5rem;
            padding: 0 0.5rem;
        }

        .mode-btn {
            padding: 0.5rem 1rem;
            background: rgba(21, 27, 35, 0.6);
            border: 1px solid rgba(0, 240, 255, 0.15);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: var(--text-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: var(--tracking-wider);
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: var(--font-mono);
        }

        .mode-btn:hover {
            background: rgba(0, 240, 255, 0.1);
            border-color: rgba(0, 240, 255, 0.3);
            color: #00f0ff;
        }

        .mode-btn.active {
            background: rgba(0, 240, 255, 0.15);
            border-color: #00f0ff;
            color: #00f0ff;
            box-shadow: var(--glow-subtle);
        }

        /* Command Input */
        .input-wrapper {
            display: grid;
            grid-template-columns: 1fr auto auto auto auto;
            gap: 0.75rem;
            align-items: center;
        }

        .input-field {
            padding: 1rem 1.25rem;
            background: rgba(10, 14, 18, 0.8);
            border: 1px solid rgba(0, 240, 255, 0.2);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: var(--text-base);
            font-family: var(--font-mono);
            resize: none;
            min-height: 48px;
            max-height: 150px;
            transition: all 0.2s ease;
            outline: none;
        }

        .input-field:focus {
            border-color: #00f0ff;
            background: rgba(10, 14, 18, 0.95);
            box-shadow: 0 0 0 2px rgba(0, 240, 255, 0.1);
        }

        .input-field::placeholder {
            color: rgba(160, 170, 184, 0.4);
            font-style: italic;
        }

        /* Action Buttons */
        .compare-btn,
        .voice-btn,
        .send-btn {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
            transition: all 0.2s ease;
            flex-shrink: 0;
            border: 1px solid;
        }


        .compare-btn {
            background: rgba(176, 38, 255, 0.1);
            border-color: rgba(176, 38, 255, 0.3);
            color: #b026ff;
        }

        .compare-btn:hover:not(:disabled) {
            background: rgba(176, 38, 255, 0.2);
            border-color: #b026ff;
        }

        .voice-btn {
            background: rgba(21, 27, 35, 0.8);
            border-color: rgba(0, 240, 255, 0.2);
            color: #00f0ff;
        }

        .voice-btn:hover {
            background: rgba(0, 240, 255, 0.1);
            border-color: #00f0ff;
        }

        .send-btn {
            background: rgba(0, 240, 255, 0.15);
            border-color: #00f0ff;
            color: #00f0ff;
        }

        .send-btn:hover:not(:disabled) {
            background: rgba(0, 240, 255, 0.25);
            box-shadow: var(--glow-medium);
        }

        .send-btn:disabled,
        .compare-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        
        /* COMPARISON VIEW */
        .comparison-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-top: 1rem;
        }
        
        .source-column {
            background: var(--bg-surface);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            border: 2px solid var(--border-subtle);
            transition: var(--transition);
        }
        
        .source-column.cloud-llm {
            border-color: var(--cloud-llm);
            box-shadow: 0 0 0 1px var(--cloud-llm-dim) inset;
        }
        
        .source-column.cloud-llm:hover {
            box-shadow: 0 0 20px var(--cloud-llm-glow);
        }
        
        .source-column.local-llm {
            border-color: var(--local-llm);
            box-shadow: 0 0 0 1px var(--local-llm-dim) inset;
        }
        
        .source-column.local-llm:hover {
            box-shadow: 0 0 20px var(--local-llm-glow);
        }
        
        .source-column.json-source {
            border-color: var(--json-source);
            box-shadow: 0 0 0 1px var(--json-source-dim) inset;
        }
        
        .source-column.json-source:hover {
            box-shadow: 0 0 20px var(--json-source-glow);
        }
        
        .source-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-subtle);
        }
        
        .source-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 700;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .source-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
        }
        
        .cloud-llm .source-icon {
            background: linear-gradient(135deg, var(--cloud-llm), #ff8fab);
            color: white;
        }
        
        .local-llm .source-icon {
            background: linear-gradient(135deg, var(--local-llm), #9b7ee0);
            color: white;
        }
        
        .json-source .source-icon {
            background: linear-gradient(135deg, var(--json-source), #00f5c4);
            color: var(--bg-void);
        }
        
        .source-status {
            padding: 0.25rem 0.625rem;
            border-radius: 100px;
            font-size: 0.625rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .status-success {
            background: var(--json-source-dim);
            color: var(--json-source);
            border: 1px solid var(--json-source);
        }
        
        .status-error {
            background: rgba(255, 107, 157, 0.12);
            color: var(--cloud-llm);
            border: 1px solid var(--cloud-llm);
        }
        
        .source-content {
            color: var(--text-primary);
            line-height: 1.7;
            font-size: 0.875rem;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .source-meta {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-subtle);
            font-size: 0.75rem;
            color: var(--text-tertiary);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .send-btn, .compare-btn, .voice-btn {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-lg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: var(--transition);
            flex-shrink: 0;
            border: 2px solid;
            position: relative;
            overflow: hidden;
        }
        
        .send-btn::before, .compare-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
            pointer-events: none;
        }
        
        .send-btn:hover::before, .compare-btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .send-btn {
            background: linear-gradient(135deg, #00f0ff, #0088cc);
            border-color: #00f0ff;
            color: #000;
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 0 30px rgba(0, 240, 255, 0.6);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .compare-btn {
            background: linear-gradient(135deg, #b026ff, #ff006e);
            border-color: #b026ff;
            color: #fff;
        }
        
        .compare-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 0 30px rgba(176, 38, 255, 0.6);
        }
        
        .compare-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .voice-btn {
            background: rgba(21, 27, 35, 0.8);
            border-color: rgba(0, 240, 255, 0.3);
            color: #00f0ff;
        }
        
        .voice-btn:hover {
            border-color: #00f0ff;
            box-shadow: 0 0 20px rgba(0, 240, 255, 0.4);
            background: rgba(21, 27, 35, 0.95);
        }
        
        .voice-btn.recording {
            background: linear-gradient(135deg, #ff006e, #ff4081);
            border-color: #ff006e;
            color: white;
            animation: voicePulse 1.5s ease-in-out infinite;
        }
        
        @keyframes voicePulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 0, 110, 0.4); }
            50% { box-shadow: 0 0 0 10px transparent; }
        }
        
        .voice-btn.recording i::before {
            content: '\f05d';
        }

        /* === TYPING INDICATOR === */
        .loading-dots {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-primary);
            animation: loadingDot 1.4s ease-in-out infinite;
        }

        .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes loadingDot {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* === EMPTY STATE === */
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            opacity: 0.6;
        }

        .empty-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }

        .empty-subtitle {
            font-size: 0.9375rem;
            line-height: 1.6;
            max-width: 500px;
        }

        .quick-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 2rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .quick-action {
            padding: 0.75rem 1.25rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .quick-action:hover {
            background: var(--bg-surface);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        /* === SCROLLBAR === */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-deep);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-elevated);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-primary-dim);
        }

        /* === TOAST === */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-strong);
            border-radius: var(--radius-lg);
            box-shadow: var(--glow-strong);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: var(--transition);
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-color: var(--accent-tertiary);
        }

        .toast.error {
            border-color: var(--accent-secondary);
        }

        /* === MODALS === */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 18, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }
        
        .modal.active {
            display: flex;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: var(--bg-surface);
            border: 1px solid var(--border-strong);
            border-radius: var(--radius-lg);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-header h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .modal-header i {
            color: var(--accent-primary);
        }
        
        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        
        .modal-close:hover {
            background: var(--bg-surface);
            color: var(--accent-secondary);
            border-color: var(--accent-secondary);
        }
        
        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-subtle);
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }
        
        .btn-primary, .btn-secondary, .btn-danger {
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-tertiary));
            color: var(--bg-void);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--glow-strong);
        }
        
        .btn-secondary {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
        }
        
        .btn-secondary:hover {
            background: var(--bg-surface);
            color: var(--text-primary);
        }
        
        .btn-danger {
            background: rgba(255, 107, 157, 0.12);
            border: 1px solid var(--cloud-llm);
            color: var(--cloud-llm);
        }
        
        .btn-danger:hover {
            background: var(--cloud-llm);
            color: white;
        }
        
        .search-filters, .settings-section {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .settings-section {
            margin-bottom: 2rem;
        }
        
        .settings-section h4 {
            font-size: 0.875rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--accent-primary);
            margin-bottom: -0.5rem;
        }
        
        .filter-group, .setting-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .filter-group label, .setting-item > label:first-child {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .filter-group input, .filter-group select, .setting-item input[type="text"], .setting-item select {
            padding: 0.75rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.875rem;
            outline: none;
            transition: var(--transition);
        }
        
        .filter-group input:focus, .filter-group select:focus, .setting-item input:focus, .setting-item select:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-primary-dim);
        }
        
        .date-range {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .date-range input {
            flex: 1;
        }
        
        .date-range span {
            color: var(--text-tertiary);
            font-size: 0.875rem;
        }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .checkbox-group label, .setting-item label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-primary);
            cursor: pointer;
        }
        
        .checkbox-group input[type="checkbox"], .setting-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent-primary);
        }
        
        .setting-item input[type="range"] {
            width: 100%;
            accent-color: var(--accent-primary);
        }
        
        .setting-item #fontSizeValue {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            font-family: 'JetBrains Mono', monospace;
        }

        .setting-item #fontSizeValue {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* === SHORTCUTS PANEL === */
        .shortcuts-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 380px;
            height: 100vh;
            background: var(--bg-surface);
            border-left: 1px solid var(--border-strong);
            box-shadow: -10px 0 40px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
        }
        
        .shortcuts-panel.active {
            right: 0;
        }
        
        .shortcuts-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .shortcuts-header h3 {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .shortcuts-header i {
            color: var(--accent-primary);
        }
        
        .shortcuts-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }
        
        .shortcut-category {
            margin-bottom: 2rem;
        }
        
        .shortcut-category:last-child {
            margin-bottom: 0;
        }
        
        .shortcut-category h4 {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--accent-primary);
            margin-bottom: 1rem;
        }
        
        .shortcut-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }
        
        .shortcut-item:hover {
            background: var(--bg-surface);
            border-color: var(--accent-primary);
        }
        
        .shortcut-keys {
            display: flex;
            gap: 0.375rem;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }
        
        .shortcut-keys kbd {
            padding: 0.25rem 0.5rem;
            background: var(--bg-void);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6875rem;
            color: var(--accent-primary);
            box-shadow: 0 2px 0 var(--border-subtle);
        }
        
        .shortcut-desc {
            font-size: 0.875rem;
            color: var(--text-primary);
            text-align: right;
        }

        

        /* === CODE EXECUTION === */
        /* Run code button removed - keeping copy functionality only */
        
        .code-output {
            margin-top: 0.75rem;
            background: var(--bg-void);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }
        
        .output-header {
            padding: 0.75rem 1rem;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .output-header i {
            color: var(--accent-tertiary);
            margin-right: 0.375rem;
        }
        
        .copy-output-btn {
            padding: 0.25rem 0.5rem;
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            color: var(--text-tertiary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.6875rem;
            transition: var(--transition);
        }
        
        .copy-output-btn:hover {
            background: var(--bg-elevated);
            color: var(--accent-primary);
            border-color: var(--accent-primary);
        }
        
        .code-output pre {
            padding: 1rem;
            margin: 0;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 0.8125rem;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .code-output pre.error {
            color: var(--cloud-llm);
        }
        
        /* Animated loader */
        .ri-spin {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: fixed;
                z-index: 1500;
            }
            
            .sidebar-toggle {
                display: flex;
            }
            
            .header {
                padding: 0.75rem 1rem;
                grid-column: 1 / -1; /* Full width on mobile */
            }
            
            .logo-text {
                font-size: 1.125rem;
            }

            .chat-container {
                padding: 0 1rem;
            }

            .message-content {
                margin-left: 0;
                padding: 1rem;
            }
            
            .message-header {
                flex-wrap: wrap;
            }

            .header-info {
                gap: 0.5rem;
            }

            .model-info, .status-badge span {
                display: none;
            }
            
            .comparison-container {
                grid-template-columns: 1fr;
            }
            
            .shortcuts-panel {
                width: 100%;
                right: -100%;
            }
            
            .modal-content {
                width: 95%;
                max-height: 90vh;
            }
            
            .input-field {
                font-size: 1rem;
                padding: 0.875rem 1rem;
            }
            
            .send-btn, .compare-btn, .voice-btn {
                width: 48px;
                height: 48px;
                font-size: 1.125rem;
            }
        }


        /* Ultimate Mode - Horizontal Grid Layout */
        .ultimate-mode {
            background: linear-gradient(180deg, rgba(15, 20, 25, 0.95), rgba(10, 14, 18, 0.95));
            border: 2px solid rgba(0, 240, 255, 0.3);
        }

        .ultimate-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .ultimate-card {
            background: rgba(21, 27, 35, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .ultimate-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .ultimate-header {
            padding: 1rem;
            background: rgba(10, 14, 18, 0.6);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .ultimate-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 700;
            font-size: 0.9375rem;
            color: var(--text-primary);
        }

        .ultimate-title i {
            font-size: 1.25rem;
        }

        .ultimate-status {
            padding: 0.25rem 0.625rem;
            border-radius: 100px;
            font-size: 0.6875rem;
            font-weight: 700;
            text-transform: uppercase;
            font-family: var(--font-mono);
        }

        .ultimate-status.status-success {
            background: rgba(0, 212, 170, 0.15);
            color: #00d4aa;
            border: 1px solid rgba(0, 212, 170, 0.3);
        }

        .ultimate-status.status-error {
            background: rgba(255, 107, 157, 0.12);
            color: #ff006e;
            border: 1px solid #ff006e;
        }

        .ultimate-meta {
            padding: 0.75rem 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
            color: var(--text-tertiary);
            font-family: var(--font-mono);
        }

        .ultimate-meta span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .ultimate-content {
            padding: 1rem;
            color: var(--text-primary);
            font-size: 0.875rem;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
        }

        /* Loading State for Ultimate Mode */
        .ultimate-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: var(--text-tertiary);
        }

        .ultimate-loading i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }

        /* Responsive - Stack on mobile */
        @media (max-width: 1024px) {
            .ultimate-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3>Conversations</h3>
                <button class="new-chat-btn" id="newChatBtn" title="New chat (Ctrl+N)">
                    <i class="ri-add-line"></i>
                </button>
            </div>
            <div class="sidebar-search">
                <div class="search-container">
                    <i class="ri-search-line"></i>
                    <input type="text" id="conversationSearch" placeholder="Search conversations...">
                </div>
            </div>
            <div class="conversation-list" id="conversationList">
                <!-- Dynamic list -->
            </div>
            <div class="sidebar-footer">
                <button class="sidebar-btn" id="exportBtn" title="Export chat">
                    <i class="ri-download-line"></i>
                    <span>Export</span>
                </button>
            </div>
        </aside>
        
        <button class="sidebar-toggle" id="sidebarToggle">
            <i class="ri-menu-fold-line"></i>
        </button>
        
        <!-- Header -->
        <header class="header">
            <div class="logo-section">
                <div class="logo-icon">
                    <img src="/static/images/cybersentry_logo.png" alt="CyberSentry AI">
                </div>
                <div class="logo-text">CyberSentry AI</div>
            </div>
            
            <div class="system-status">
                <div class="status-item">
                    <span class="status-indicator active"></span>
                    <span class="status-item-label">Engine:</span>
                    <span class="status-item-value">ACTIVE</span>
                </div>
                <div class="status-item">
                    <span class="status-item-label">Updated:</span>
                    <span class="status-item-value" id="lastUpdate">Just now</span>
                </div>
                <div class="status-item">
                    <span class="status-item-label">Compliance:</span>
                    <span class="status-item-value" id="complianceStatus">Checking...</span>
                </div>
                <div class="status-item">
                    <span class="status-item-label">Version:</span>
                    <span class="status-item-value">v4.5</span>
                </div>
            </div>
            
            <div class="header-info">
                <button class="theme-toggle" id="readingModeToggle" title="Reading Mode (R)">
                    <i class="ri-book-open-line"></i>
                </button>
                <button class="theme-toggle" id="densityToggle" title="Content Density">
                    <i class="ri-text-spacing"></i>
                </button>
                <button class="theme-toggle" id="themeToggle" title="Toggle theme">
                    <i class="ri-moon-line"></i>
                </button>
            </div>
        </header>
        
        
        <!-- Chat Container -->
        <div class="chat-container">
            <div class="messages-area" id="messagesArea">
                <!-- Welcome Message -->
                <div class="message">
                    <div class="message-header">
                        <div class="message-avatar ai">
                            <i class="ri-shield-check-fill"></i>
                        </div>
                        <div class="message-meta">
                            <span class="message-sender">CyberSentry AI</span>
                            <span class="message-time" id="welcomeTime"></span>
                            <span class="message-badge badge-ai">SYSTEM</span>
                        </div>
                    </div>
                    <div class="message-content ai">
                        <div class="message-text">
                            <strong>⚡ CYBERSENTRY AI v4.5</strong> – Neural Security Interface
                            <br><br>
                            <code>SYSTEM:</code> <strong>ONLINE</strong><br>
                            <code>AI CORES:</code> Multi-source intelligence active<br>
                            <code>SECURITY:</code> Maximum encryption enabled
                            <br><br>
                            <span style="color: var(--accent-primary);">► CAPABILITIES:</span>
                            <br>
                            <code>•</code> Advanced threat analysis<br>
                            <code>•</code> Security tool guidance<br>
                            <code>•</code> Penetration testing frameworks<br>
                            <code>•</code> Real-time vulnerability detection
                            <br><br>
                            <span style="color: var(--accent-tertiary);">AWAITING INPUT...</span>
                        </div>
                    </div>
                </div>
                <!-- Footer buffer for visual spacing -->
                <div class="footer-buffer"></div>
            </div>
            
            <!-- Section Jump Navigator -->
            <div class="section-nav" id="sectionNav" style="display: none;">
                <div class="section-nav-title">Quick Jump</div>
                <div id="sectionNavItems"></div>
            </div>

            <!-- Input Area -->
            <div class="input-area">
                <div class="command-console">
                    <div class="mode-selector">
                        <button class="mode-btn active" data-mode="advisory">Advisory</button>
                        <button class="mode-btn" data-mode="report">Report</button>
                    </div>
                    
                    <div class="input-wrapper">
                        <textarea 
                            id="userInput" 
                            class="input-field" 
                            placeholder="Enter security query or command..."
                            rows="1"
                        ></textarea>
                        <button class="compare-btn" id="compareBtn" title="Compare all sources (Ctrl+Shift+Enter)">
                            <i class="ri-layout-column-fill"></i>
                        </button>
                        <button class="voice-btn" id="voiceBtn" title="Voice input (Ctrl+M)">
                            <i class="ri-mic-line"></i>
                        </button>
                        <button class="send-btn" id="sendBtn" title="Execute (Enter)">
                            <i class="ri-send-plane-fill"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Advanced Search Modal -->
    <div class="modal" id="searchModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="ri-search-line"></i> Advanced Search</h3>
                <button class="modal-close" onclick="closeModal('searchModal')">
                    <i class="ri-close-line"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="search-filters">
                    <div class="filter-group">
                        <label>Search Query</label>
                        <input type="text" id="advancedSearchQuery" placeholder="Enter keywords...">
                    </div>
                    <div class="filter-group">
                        <label>Source</label>
                        <select id="sourceFilter">
                            <option value="all">All Sources</option>
                            <option value="JSON">JSON Database</option>
                            <option value="AI">Cloud LLM</option>
                            <option value="local">Local LLM</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Date Range</label>
                        <div class="date-range">
                            <input type="date" id="dateFrom">
                            <span>to</span>
                            <input type="date" id="dateTo">
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>Threat Level</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" value="CRITICAL"> Critical</label>
                            <label><input type="checkbox" value="HIGH"> High</label>
                            <label><input type="checkbox" value="MEDIUM"> Medium</label>
                            <label><input type="checkbox" value="LOW"> Low</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('searchModal')">Cancel</button>
                <button class="btn-primary" onclick="performAdvancedSearch()">Search</button>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="ri-settings-3-line"></i> Settings</h3>
                <button class="modal-close" onclick="closeModal('settingsModal')">
                    <i class="ri-close-line"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h4>Appearance</h4>
                    <div class="setting-item">
                        <label>Theme</label>
                        <select id="themeSelect">
                            <option value="dark">Dark Mode</option>
                            <option value="light">Light Mode</option>
                            <option value="auto">Auto (System)</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label>Font Size</label>
                        <input type="range" id="fontSizeRange" min="12" max="20" value="14">
                        <span id="fontSizeValue">14px</span>
                    </div>
                    <div class="setting-item">
                        <label>Code Theme</label>
                        <select id="codeTheme">
                            <option value="monokai">Monokai</option>
                            <option value="dracula">Dracula</option>
                            <option value="github">GitHub</option>
                        </select>
                    </div>
                </div>
                <div class="settings-section">
                    <h4>AI Preferences</h4>
                    <div class="setting-item">
                        <label>Preferred Source</label>
                        <select id="preferredSource">
                            <option value="auto">Auto (Smart)</option>
                            <option value="json">JSON First</option>
                            <option value="cloud">Cloud LLM First</option>
                            <option value="local">Local LLM First</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label>Response Length</label>
                        <select id="responseLength">
                            <option value="short">Short (Concise)</option>
                            <option value="medium">Medium (Balanced)</option>
                            <option value="long">Long (Detailed)</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label>
                            <input type="checkbox" id="autoSuggest" checked>
                            Enable Smart Suggestions
                        </label>
                    </div>
                    <div class="setting-item">
                        <label>
                            <input type="checkbox" id="threatAnalysis" checked>
                            Real-time Threat Analysis
                        </label>
                    </div>
                </div>
                <div class="settings-section">
                    <h4>Privacy & Data</h4>
                    <div class="setting-item">
                        <label>
                            <input type="checkbox" id="saveHistory" checked>
                            Save Conversation History
                        </label>
                    </div>
                    <div class="setting-item">
                        <label>
                            <input type="checkbox" id="analytics">
                            Share Anonymous Analytics
                        </label>
                    </div>
                    <div class="setting-item">
                        <button class="btn-danger" onclick="clearAllData()">
                            <i class="ri-delete-bin-line"></i> Clear All Data
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('settingsModal')">Cancel</button>
                <button class="btn-primary" onclick="saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>
    
    <!-- Keyboard Shortcuts Panel -->
    <div class="shortcuts-panel" id="shortcutsPanel">
        <div class="shortcuts-header">
            <h3><i class="ri-keyboard-line"></i> Keyboard Shortcuts</h3>
            <button class="modal-close" onclick="toggleShortcuts()">
                <i class="ri-close-line"></i>
            </button>
        </div>
        <div class="shortcuts-body">
            <div class="shortcut-category">
                <h4>Navigation</h4>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <kbd>Ctrl</kbd> + <kbd>K</kbd>
                    </div>
                    <div class="shortcut-desc">Focus input</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <kbd>Ctrl</kbd> + <kbd>L</kbd>
                    </div>
                    <div class="shortcut-desc">Clear chat</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <kbd>Ctrl</kbd> + <kbd>N</kbd>
                    </div>
                    <div class="shortcut-desc">New conversation</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <kbd>Ctrl</kbd> + <kbd>B</kbd>
                    </div>
                    <div class="shortcut-desc">Toggle sidebar</div>
                </div>
            </div>
            <div class="shortcut-category">
                <h4>Actions</h4>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <kbd>Enter</kbd>
                    </div>
                    <div class="shortcut-desc">Send message</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <kbd>Shift</kbd> + <kbd>Enter</kbd>
                    </div>
                    <div class="shortcut-desc">New line</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <kbd>Ctrl</kbd> + <kbd>Shift</kbd> + <kbd>Enter</kbd>
                    </div>
                    <div class="shortcut-desc">Compare sources</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <kbd>Ctrl</kbd> + <kbd>M</kbd>
                    </div>
                    <div class="shortcut-desc">Voice input</div>
                </div>
            </div>
            <div class="shortcut-category">
                <h4>View</h4>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <kbd>Ctrl</kbd> + <kbd>T</kbd>
                    </div>
                    <div class="shortcut-desc">Toggle theme</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <kbd>Ctrl</kbd> + <kbd>F</kbd>
                    </div>
                    <div class="shortcut-desc">Advanced search</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <kbd>Ctrl</kbd> + <kbd>,</kbd>
                    </div>
                    <div class="shortcut-desc">Settings</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <kbd>Ctrl</kbd> + <kbd>/</kbd>
                    </div>
                    <div class="shortcut-desc">Show shortcuts</div>
                </div>
            </div>
            <div class="shortcut-category">
                <h4>Other</h4>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <kbd>Esc</kbd>
                    </div>
                    <div class="shortcut-desc">Clear input / Close modal</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <kbd>Ctrl</kbd> + <kbd>E</kbd>
                    </div>
                    <div class="shortcut-desc">Export conversation</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <kbd>Ctrl</kbd> + <kbd>S</kbd>
                    </div>
                    <div class="shortcut-desc">Save to history</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global State
        const API_BASE = window.location.origin + '/cybersentry_ai';
        let conversationCount = 0;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            initializeEventListeners();
            displayWelcomeTime();
        });

        function initializeApp() {
            console.log('🛡️ CyberSentry AI initialized');
            updateStatus('ready');
            updateRealTimeStatus();
            // Update status every 30 seconds
            setInterval(updateRealTimeStatus, 30000);
            
            // Initialize reading progress indicator
            initializeReadingProgress();
            
            // Initialize active section highlighting
            initializeActiveSectionHighlight();
            
            // Initialize reading mode toggle
            initializeReadingMode();
            
            // Initialize density toggle
            initializeDensityToggle();
            
            // Initialize section navigator
            initializeSectionNavigator();
            
            // Initialize collapsible sections
            initializeCollapsibleSections();
        }
        
        // Reading Mode Toggle
        function initializeReadingMode() {
            const readingModeToggle = document.getElementById('readingModeToggle');
            if (readingModeToggle) {
                readingModeToggle.addEventListener('click', () => {
                    document.body.classList.toggle('reading-mode');
                    const isActive = document.body.classList.contains('reading-mode');
                    readingModeToggle.title = isActive ? 'Exit Reading Mode (R)' : 'Reading Mode (R)';
                    showToast(isActive ? '📖 Reading mode enabled' : '📄 Reading mode disabled', 'success');
                });
            }
            
            // Keyboard shortcut: R key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'r' && !e.ctrlKey && !e.shiftKey && !e.altKey) {
                    const activeElement = document.activeElement;
                    if (activeElement.tagName !== 'INPUT' && activeElement.tagName !== 'TEXTAREA') {
                        e.preventDefault();
                        readingModeToggle?.click();
                    }
                }
            });
        }
        
        // Density Toggle
        let currentDensity = 'comfortable';
        function initializeDensityToggle() {
            const densityToggle = document.getElementById('densityToggle');
            if (densityToggle) {
                densityToggle.addEventListener('click', () => {
                    const densities = ['compact', 'comfortable', 'spacious'];
                    const currentIndex = densities.indexOf(currentDensity);
                    const nextIndex = (currentIndex + 1) % densities.length;
                    currentDensity = densities[nextIndex];
                    
                    // Remove all density classes
                    document.body.classList.remove('density-compact', 'density-comfortable', 'density-spacious');
                    // Add new density class
                    document.body.classList.add(`density-${currentDensity}`);
                    
                    const labels = {
                        compact: 'Compact',
                        comfortable: 'Comfortable',
                        spacious: 'Spacious'
                    };
                    
                    densityToggle.title = `Content Density: ${labels[currentDensity]}`;
                    showToast(`📐 Density: ${labels[currentDensity]}`, 'success');
                });
                
                // Initialize with comfortable
                document.body.classList.add('density-comfortable');
            }
        }
        
        // Section Navigator
        function initializeSectionNavigator() {
            const sectionNav = document.getElementById('sectionNav');
            const sectionNavItems = document.getElementById('sectionNavItems');
            const messagesArea = document.getElementById('messagesArea');
            
            if (!sectionNav || !sectionNavItems || !messagesArea) return;
            
            const updateSectionNav = () => {
                const sections = document.querySelectorAll('.section h2, .message-content h2, .report-title');
                if (sections.length === 0) {
                    sectionNav.style.display = 'none';
                    return;
                }
                
                sectionNav.style.display = 'block';
                sectionNavItems.innerHTML = '';
                
                sections.forEach((section, index) => {
                    const title = section.textContent.replace(' #', '').trim();
                    const navItem = document.createElement('a');
                    navItem.href = '#';
                    navItem.className = 'section-nav-item';
                    navItem.textContent = title.length > 30 ? title.substring(0, 30) + '...' : title;
                    navItem.dataset.index = index;
                    
                    navItem.addEventListener('click', (e) => {
                        e.preventDefault();
                        const targetPosition = section.getBoundingClientRect().top + messagesArea.scrollTop - 100;
                        
                        // Smooth scroll with easing
                        const startPosition = messagesArea.scrollTop;
                        const distance = targetPosition - startPosition;
                        const duration = 600;
                        let start = null;
                        
                        function smoothScroll(currentTime) {
                            if (start === null) start = currentTime;
                            const timeElapsed = currentTime - start;
                            const progress = Math.min(timeElapsed / duration, 1);
                            
                            // Easing function (ease-in-out-cubic)
                            const ease = progress < 0.5 
                                ? 4 * progress * progress * progress 
                                : 1 - Math.pow(-2 * progress + 2, 3) / 2;
                            
                            messagesArea.scrollTop = startPosition + distance * ease;
                            
                            if (timeElapsed < duration) {
                                requestAnimationFrame(smoothScroll);
                            }
                        }
                        
                        requestAnimationFrame(smoothScroll);
                    });
                    
                    sectionNavItems.appendChild(navItem);
                });
            };
            
            // Update on scroll
            messagesArea.addEventListener('scroll', () => {
                const sections = document.querySelectorAll('.section h2, .message-content h2, .report-title');
                const scrollTop = messagesArea.scrollTop;
                
                sections.forEach((section, index) => {
                    const rect = section.getBoundingClientRect();
                    const sectionTop = rect.top + messagesArea.scrollTop;
                    const navItem = sectionNavItems.querySelector(`[data-index="${index}"]`);
                    
                    if (navItem) {
                        if (scrollTop >= sectionTop - 200 && scrollTop < sectionTop + 200) {
                            navItem.classList.add('active');
                        } else {
                            navItem.classList.remove('active');
                        }
                    }
                });
            });
            
            // Update when new content is added
            const observer = new MutationObserver(updateSectionNav);
            observer.observe(messagesArea, { childList: true, subtree: true });
            
            // Initial update
            updateSectionNav();
        }
        
        // Collapsible Sections
        function initializeCollapsibleSections() {
            document.addEventListener('click', (e) => {
                const h2 = e.target.closest('.section h2');
                if (h2) {
                    const section = h2.closest('.section');
                    if (section) {
                        section.classList.toggle('collapsed');
                    }
                }
            });
        }
        
        // Reading progress indicator
        function initializeReadingProgress() {
            // Create progress bar if it doesn't exist
            let progressBar = document.querySelector('.read-progress');
            if (!progressBar) {
                progressBar = document.createElement('div');
                progressBar.className = 'read-progress';
                document.body.appendChild(progressBar);
            }
            
            const messagesArea = document.getElementById('messagesArea');
            if (messagesArea) {
                messagesArea.addEventListener('scroll', () => {
                    const scrollTop = messagesArea.scrollTop;
                    const scrollHeight = messagesArea.scrollHeight - messagesArea.clientHeight;
                    const progress = (scrollTop / scrollHeight) * 100;
                    progressBar.style.width = progress + '%';
                });
            }
        }
        
        // Active section highlighting on scroll
        function initializeActiveSectionHighlight() {
            const messagesArea = document.getElementById('messagesArea');
            if (!messagesArea) return;
            
            const sections = document.querySelectorAll('.section, .message-content');
            
            const updateActiveSection = () => {
                const scrollTop = messagesArea.scrollTop;
                const viewportHeight = messagesArea.clientHeight;
                const viewportCenter = scrollTop + viewportHeight / 2;
                
                let activeSection = null;
                let minDistance = Infinity;
                
                sections.forEach(section => {
                    const rect = section.getBoundingClientRect();
                    const sectionTop = rect.top + messagesArea.scrollTop;
                    const sectionCenter = sectionTop + rect.height / 2;
                    const distance = Math.abs(viewportCenter - sectionCenter);
                    
                    if (distance < minDistance) {
                        minDistance = distance;
                        activeSection = section;
                    }
                });
                
                // Update active class
                sections.forEach(section => {
                    section.classList.remove('active');
                });
                
                if (activeSection) {
                    activeSection.classList.add('active');
                }
            };
            
            messagesArea.addEventListener('scroll', updateActiveSection);
            updateActiveSection(); // Initial call
        }
        
        function updateRealTimeStatus() {
            // Update last update time
            const lastUpdate = document.getElementById('lastUpdate');
            if (lastUpdate) {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false 
                });
                lastUpdate.textContent = timeStr;
            }
            
            // Update compliance status (check from API or use default)
            const complianceStatus = document.getElementById('complianceStatus');
            if (complianceStatus) {
                // In a real app, this would fetch from an API
                const complianceFrameworks = ['PCI-DSS', 'HIPAA', 'ISO 27001', 'SOC 2', 'GDPR'];
                const randomFramework = complianceFrameworks[Math.floor(Math.random() * complianceFrameworks.length)];
                complianceStatus.textContent = randomFramework;
            }
        }

        function displayWelcomeTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
            document.getElementById('welcomeTime').textContent = timeStr;
        }

        function initializeEventListeners() {
            // Send button
            document.getElementById('sendBtn').addEventListener('click', sendMessage);

            // Enter key (Shift+Enter for new line)
            document.getElementById('userInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey) {
                    e.preventDefault();
                    sendMessage();
                } else if (e.key === 'Enter' && e.ctrlKey && e.shiftKey) {
                    e.preventDefault();
                    compareAllSources();
                }
            });
            
            // Global keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Ctrl+K: Focus input
                if (e.ctrlKey && e.key === 'k') {
                    e.preventDefault();
                    document.getElementById('userInput').focus();
                }
                // Ctrl+L: Clear chat
                if (e.ctrlKey && e.key === 'l') {
                    e.preventDefault();
                    if (confirm('Clear all messages?')) {
                        const messagesArea = document.getElementById('messagesArea');
                        messagesArea.innerHTML = '';
                        initializeApp();
                    }
                }
                // Escape: Clear input
                if (e.key === 'Escape') {
                    document.getElementById('userInput').value = '';
                    document.getElementById('userInput').style.height = 'auto';
                }
            });
            
            // Compare button
            document.getElementById('compareBtn').addEventListener('click', compareAllSources);
            
            
            // Mode selector functionality
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const mode = btn.dataset.mode;
                    const placeholder = {
                        'advisory': 'Enter security query or command...',
                        'report': 'Generate report for...'
                    };
                    
                    document.getElementById('userInput').placeholder = placeholder[mode] || 'Enter security query or command...';
                    
                    // If Report mode, trigger summarization
                    if (mode === 'report') {
                        generateReport();
                    } else {
                        showToast(`Mode: ${mode.toUpperCase()}`, 'success');
                    }
                });
            });
            
            // Generate report function
            function generateReport() {
                const messages = document.querySelectorAll('.message');
                if (messages.length <= 1) {
                    showToast('No conversation to summarize', 'error');
                    return;
                }
                
                // Collect conversation text
                let conversationText = '';
                messages.forEach(msg => {
                    const sender = msg.querySelector('.message-sender')?.textContent;
                    const text = msg.querySelector('.message-text')?.textContent || 
                                msg.querySelector('.report-body')?.textContent;
                    if (sender && text) {
                        conversationText += `${sender}: ${text.trim()}\n\n`;
                    }
                });
                
                if (!conversationText.trim()) {
                    showToast('No conversation content found', 'error');
                    return;
                }
                
                // Show typing indicator
                const typingId = addTypingIndicator();
                updateStatus('processing');
                
                // Send to AI for summarization
                fetch(`${API_BASE}/ask`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        question: `Please provide a comprehensive security report summarizing the following conversation:\n\n${conversationText}\n\nGenerate a structured report with key findings, recommendations, and action items.`
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => Promise.reject(new Error(err.error || `HTTP ${response.status}`)));
                    }
                    return response.json();
                })
                .then(data => {
                    removeTypingIndicator(typingId);
                    if (data.error) {
                        addErrorMessage(data.error || 'Failed to generate report');
                        updateStatus('ready');
                        showToast('✗ Report generation failed', 'error');
                    } else if (data.answer) {
                        // Display report with Ultimate button
                        addReportMessage(data, conversationText);
                        updateStatus('ready');
                        showToast('✓ Report generated', 'success');
                    } else {
                        addErrorMessage('No answer received from server');
                        updateStatus('ready');
                        showToast('✗ Report generation failed', 'error');
                    }
                })
                .catch(error => {
                    removeTypingIndicator(typingId);
                    addErrorMessage(error.message || 'Failed to generate report');
                    updateStatus('ready');
                    showToast('✗ Report generation failed', 'error');
                });
            }
            
            function addReportMessage(response, conversationText) {
                const time = getCurrentTime();
                const answer = response.answer || response.response || '';
                
                const html = `
                    <div class="message">
                        <div class="message-header">
                            <div class="message-avatar ai">
                                <i class="ri-shield-check-fill"></i>
                            </div>
                            <div class="message-meta">
                                <span class="message-sender">CyberSentry</span>
                                <span class="message-time">${time}</span>
                                <span class="message-badge badge-ai">REPORT</span>
                            </div>
                        </div>
                        <div class="message-content ai">
                            <div class="report-header">
                                <div class="report-title">Security Conversation Report</div>
                                <div class="report-meta">
                                    <span>${time}</span>
                                </div>
                            </div>
                            <div class="report-body">
                                <div class="message-text">${formatResponse(answer)}</div>
                                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(0, 240, 255, 0.15);">
                                    <button class="mode-btn active" id="ultimateBtn" style="width: 100%; justify-content: center; margin-top: 0.5rem;">
                                        <i class="ri-database-2-line"></i> Ultimate Analysis
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('messagesArea').appendChild(createElementFromHTML(html));
                
                // Add Ultimate button event listener
                setTimeout(() => {
                    const ultimateBtn = document.getElementById('ultimateBtn');
                    if (ultimateBtn) {
                        ultimateBtn.addEventListener('click', () => {
                            // Use /all function
                            getAllSourcesForReport(conversationText);
                        });
                    } else {
                        console.warn('Ultimate button not found');
                    }
                }, 100);
                
                scrollToBottom();
            }
            
            // Update getAllSourcesForReport to use loading indicator and improved Ultimate Mode
            function getAllSourcesForReport(conversationText) {
                const question = `Provide comprehensive analysis of the following security conversation:\n\n${conversationText}`;
                
                // Show loading with visual feedback
                const loadingId = addUltimateLoadingMessage();
                updateStatus('processing');
                showToast('⚡ Processing all sources...', 'success');
                
                // Send to /ask-all endpoint
                fetch(`${API_BASE}/ask-all`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: question })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => Promise.reject(new Error(err.error || `HTTP ${response.status}`)));
                    }
                    return response.json();
                })
                .then(data => {
                    // Remove loading indicator
                    document.getElementById(loadingId)?.remove();
                    
                    if (data.error) {
                        addErrorMessage(data.error || 'Failed to retrieve all sources');
                        updateStatus('ready');
                        showToast('✗ Ultimate analysis failed', 'error');
                    } else if (data.results || data.json || data.cloud_llm || data.local_llm) {
                        addAllSourcesMessage(data, question);
                        updateStatus('ready');
                        showToast('✓ Ultimate analysis complete', 'success');
                    } else {
                        addErrorMessage('No sources returned');
                        updateStatus('ready');
                        showToast('✗ Ultimate analysis failed', 'error');
                    }
                })
                .catch(error => {
                    document.getElementById(loadingId)?.remove();
                    addErrorMessage(error.message || 'Failed to process request');
                    updateStatus('ready');
                    showToast('✗ Ultimate analysis failed', 'error');
                });
            }
            
            // Voice button
            document.getElementById('voiceBtn').addEventListener('click', toggleVoiceInput);
            
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // Sidebar toggle
            document.getElementById('sidebarToggle')?.addEventListener('click', toggleSidebar);
            
            // New chat
            document.getElementById('newChatBtn')?.addEventListener('click', startNewChat);
            
            // Export button
            document.getElementById('exportBtn')?.addEventListener('click', () => {
                const format = prompt('Export format (json/txt/md/pdf):', 'pdf');
                if (format) exportConversation(format);
            });
            
            // Advanced keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Ctrl+T: Toggle theme
                if (e.ctrlKey && e.key === 't') {
                    e.preventDefault();
                    toggleTheme();
                }
                // Ctrl+N: New chat
                if (e.ctrlKey && e.key === 'n') {
                    e.preventDefault();
                    startNewChat();
                }
                // Ctrl+B: Toggle sidebar
                if (e.ctrlKey && e.key === 'b') {
                    e.preventDefault();
                    toggleSidebar();
                }
                // Ctrl+F: Advanced search
                if (e.ctrlKey && e.key === 'f') {
                    e.preventDefault();
                    openModal('searchModal');
                }
                // Ctrl+,: Settings
                if (e.ctrlKey && e.key === ',') {
                    e.preventDefault();
                    openModal('settingsModal');
                }
                // Ctrl+/: Show shortcuts
                if (e.ctrlKey && e.key === '/') {
                    e.preventDefault();
                    toggleShortcuts();
                }
                // Ctrl+M: Voice input
                if (e.ctrlKey && e.key === 'm') {
                    e.preventDefault();
                    toggleVoiceInput();
                }
                // Ctrl+E: Export
                if (e.ctrlKey && e.key === 'e') {
                    e.preventDefault();
                    exportConversation('json');
                }
                // Ctrl+S: Save (prevent default browser save)
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    showToast('💾 Conversation auto-saved', 'success');
                }
            });
            
            // Load settings from localStorage
            loadSettings();
            
            // Load conversation history
            loadConversationHistory();
            
            
            
            

            // Auto-resize textarea
            document.getElementById('userInput').addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 200) + 'px';
            });

            // Copy and regenerate buttons
            document.addEventListener('click', (e) => {
                if (e.target.closest('.action-btn[data-action="copy"]')) {
                    const btn = e.target.closest('.action-btn');
                    const text = btn.closest('.message-content').querySelector('.message-text').textContent;
                    copyToClipboard(text, btn);
                }

                if (e.target.closest('.action-btn[data-action="regenerate"]')) {
                    const btn = e.target.closest('.action-btn');
                    const question = btn.dataset.question;
                    const source = btn.dataset.source;
                    regenerateResponse(question, source);
                }
            });
        }

        function sendMessage() {
            const input = document.getElementById('userInput');
            const question = input.value.trim();

            if (!question) return;

            // Disable input
            input.disabled = true;
            document.getElementById('sendBtn').disabled = true;

            // Add user message
            addUserMessage(question);
            input.value = '';
            input.style.height = 'auto';

            // Show typing indicator
            const typingId = addTypingIndicator();
            updateStatus('processing');

            // Send to backend
            fetch(`${API_BASE}/ask`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question: question })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => Promise.reject(new Error(err.error || `HTTP ${response.status}`)));
                }
                return response.json();
            })
            .then(data => {
                removeTypingIndicator(typingId);
                if (data.error) {
                    addErrorMessage(data.error);
                    updateStatus('ready');
                    showToast('✗ Request failed', 'error');
                } else {
                    addAIMessage(data, question);
                    updateStatus('ready');
                    conversationCount++;
                    showToast('✓ Response received', 'success');
                }
            })
            .catch(error => {
                removeTypingIndicator(typingId);
                addErrorMessage(error.message || 'Failed to process request');
                updateStatus('ready');
                showToast('✗ Request failed', 'error');
            })
            .finally(() => {
                input.disabled = false;
                document.getElementById('sendBtn').disabled = false;
                input.focus();
            });
        }

        function addUserMessage(text) {
            const time = getCurrentTime();
            const html = `
                <div class="message">
                    <div class="message-header">
                        <div class="message-avatar user">
                            <i class="ri-user-3-fill"></i>
                        </div>
                        <div class="message-meta">
                            <span class="message-sender">You</span>
                            <span class="message-time">${time}</span>
                        </div>
                    </div>
                    <div class="message-content user">
                        <div class="message-text">${escapeHtml(text)}</div>
                    </div>
                </div>
            `;
            document.getElementById('messagesArea').appendChild(createElementFromHTML(html));
            scrollToBottom();
        }

        function formatSecurityResponse(response) {
            const content = response.answer || '';
            const source = response.source || 'AI';
            
            // Check if response has structured data
            if (response.structured) {
                return formatStructuredReport(response.structured);
            }
            
            // Otherwise format as clean text
            return `
                <div class="report-header">
                    <div class="report-title">${response.title || 'Security Advisory'}</div>
                    <div class="report-meta">
                        <span>Source: ${source}</span>
                        <span>•</span>
                        <span>${getCurrentTime()}</span>
                    </div>
                </div>
                <div class="report-body">
                    <div class="message-text">${formatResponse(content)}</div>
                </div>
            `;
        }

        function formatStructuredReport(data) {
            let html = `
                <div class="report-header">
                    <div class="report-title">${data.title || 'Security Report'}</div>
                    <div class="report-meta">
                        <span>Risk: ${data.risk || 'N/A'}</span>
                        <span>•</span>
                        <span>Assets: ${data.assets || 'N/A'}</span>
                    </div>
                </div>
                <div class="report-body">
            `;
            
            if (data.summary) {
                html += `<div class="message-text">${formatResponse(data.summary)}</div>`;
            }
            
            if (data.findings && data.findings.length > 0) {
                html += `
                    <div class="security-block">
                        <div class="security-block-header">🛡 Critical Findings</div>
                        <ul class="security-list">
                            ${data.findings.map(f => `<li>${escapeHtml(f)}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            if (data.recommendations && data.recommendations.length > 0) {
                html += `
                    <div class="security-block">
                        <div class="security-block-header">✓ Recommended Actions</div>
                        <ul class="security-list">
                            ${data.recommendations.map(r => `<li>${escapeHtml(r)}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }

        function addAIMessage(response, question) {
            const time = getCurrentTime();
            const source = response.source || 'AI';
            const canRegenerate = response.can_regenerate !== false;
            
            let badgeClass = 'badge-ai';
            let badgeText = source.toUpperCase();
            
            if (source === 'JSON') {
                badgeClass = 'badge-json';
            }

            let actionsHtml = '';
            if (canRegenerate) {
                const altSource = source === 'JSON' ? 'ai' : 'json';
                actionsHtml = `
                    <div class="card-actions">
                        <button class="action-btn" data-action="copy">
                            <i class="ri-file-copy-line"></i> Copy
                        </button>
                        <button class="action-btn" data-action="regenerate" data-question="${escapeHtml(question)}" data-source="${altSource}">
                            <i class="ri-refresh-line"></i> Regenerate
                        </button>
                    </div>
                `;
            }

            const formattedContent = formatSecurityResponse(response);

            const html = `
                <div class="message">
                    <div class="message-header">
                        <div class="message-avatar ai">
                            <i class="ri-shield-check-fill"></i>
                        </div>
                        <div class="message-meta">
                            <span class="message-sender">CyberSentry</span>
                            <span class="message-time">${time}</span>
                            <span class="message-badge ${badgeClass}">${badgeText}</span>
                        </div>
                    </div>
                    <div class="message-content ai">
                        ${formattedContent}
                        ${actionsHtml}
                    </div>
                </div>
            `;
            document.getElementById('messagesArea').appendChild(createElementFromHTML(html));
            scrollToBottom();
        }

        function formatResponse(text) {
            // Check if text is already HTML (contains HTML tags)
            if (text.includes('<') && text.includes('>')) {
                // Already HTML, return as-is (but sanitize)
                return sanitizeHTML(text);
            }
            
            // Otherwise, treat as markdown/plain text
            // Escape HTML first
            text = escapeHtml(text);
            
            // Bold **text**
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Code blocks ```language\ncode\n```
            text = text.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
            
            // Inline code `code`
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Line breaks
            text = text.replace(/\n/g, '<br>');
            
            return text;
        }

        function sanitizeHTML(html) {
            // Basic HTML sanitization - allow safe tags
            const allowedTags = ['strong', 'em', 'code', 'pre', 'br', 'p', 'ul', 'ol', 'li', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'];
            const div = document.createElement('div');
            div.innerHTML = html;
            
            // Remove script tags and dangerous attributes
            const scripts = div.querySelectorAll('script, iframe, object, embed');
            scripts.forEach(s => s.remove());
            
            // Remove dangerous attributes
            div.querySelectorAll('*').forEach(el => {
                Array.from(el.attributes).forEach(attr => {
                    if (attr.name.startsWith('on') || attr.name === 'href' && attr.value.startsWith('javascript:')) {
                        el.removeAttribute(attr.name);
                    }
                });
            });
            
            return div.innerHTML;
        }

        function addTypingIndicator() {
            const time = getCurrentTime();
            const id = 'typing-' + Date.now();
            const html = `
                <div class="message" id="${id}">
                    <div class="message-header">
                        <div class="message-avatar ai">
                            <i class="ri-shield-check-fill"></i>
                        </div>
                        <div class="message-meta">
                            <span class="message-sender">CyberSentry AI</span>
                            <span class="message-time">${time}</span>
                        </div>
                    </div>
                    <div class="message-content ai">
                        <div class="message-text">
                            <div class="loading-dots">
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('messagesArea').appendChild(createElementFromHTML(html));
            scrollToBottom();
            return id;
        }

        function removeTypingIndicator(id) {
            const element = document.getElementById(id);
            if (element) element.remove();
        }

        function addErrorMessage(error) {
            const time = getCurrentTime();
            const html = `
                <div class="message">
                    <div class="message-header">
                        <div class="message-avatar ai">
                            <i class="ri-error-warning-fill"></i>
                        </div>
                        <div class="message-meta">
                            <span class="message-sender">System</span>
                            <span class="message-time">${time}</span>
                            <span class="message-badge" style="background: rgba(255, 107, 157, 0.12); color: var(--accent-secondary); border: 1px solid var(--accent-secondary);">ERROR</span>
                        </div>
                    </div>
                    <div class="message-content" style="border-color: var(--accent-secondary);">
                        <div class="message-text">${escapeHtml(error)}</div>
                    </div>
                </div>
            `;
            document.getElementById('messagesArea').appendChild(createElementFromHTML(html));
            scrollToBottom();
        }

        function regenerateResponse(question, forceSource) {
            // Remove last AI message
            const messages = document.querySelectorAll('.message');
            if (messages.length > 0) {
                messages[messages.length - 1].remove();
            }

            // Show typing indicator
            const typingId = addTypingIndicator();
            updateStatus('regenerating');

            // Send request with forced source
            fetch(`${API_BASE}/ask`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    question: question,
                    force_source: forceSource 
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => Promise.reject(new Error(err.error || `HTTP ${response.status}`)));
                }
                return response.json();
            })
            .then(data => {
                removeTypingIndicator(typingId);
                if (data.error) {
                    addErrorMessage(data.error);
                    updateStatus('ready');
                    showToast('✗ Regeneration failed', 'error');
                } else {
                    addAIMessage(data, question);
                    updateStatus('ready');
                    showToast(`✓ Regenerated using ${forceSource.toUpperCase()}`, 'success');
                }
            })
            .catch(error => {
                removeTypingIndicator(typingId);
                addErrorMessage(error.message || 'Failed to regenerate');
                updateStatus('ready');
                showToast('✗ Regeneration failed', 'error');
            });
        }

        function copyToClipboard(text, button) {
            // Check if button has data-text attribute (for copy all)
            const textToCopy = button.dataset.text || text;
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="ri-check-line"></i> Copied!';
                button.style.color = 'var(--accent-tertiary)';
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.color = '';
                }, 2000);
                showToast('✓ Copied to clipboard', 'success');
            }).catch(() => {
                showToast('✗ Failed to copy', 'error');
            });
        }

        function updateStatus(status) {
            // Update status indicator in header if it exists
            const statusIndicator = document.querySelector('.status-indicator');
            if (statusIndicator) {
                switch(status) {
                    case 'ready':
                        statusIndicator.classList.add('active');
                        statusIndicator.classList.remove('warning');
                        break;
                    case 'processing':
                    case 'regenerating':
                        statusIndicator.classList.add('active');
                        statusIndicator.classList.remove('warning');
                        break;
                    default:
                        statusIndicator.classList.add('active');
                }
            }
        }

        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
        }

        function scrollToBottom() {
            const messagesArea = document.getElementById('messagesArea');
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function createElementFromHTML(htmlString) {
            const div = document.createElement('div');
            div.innerHTML = htmlString.trim();
            return div.firstChild;
        }

        function getAllSources() {
            const input = document.getElementById('userInput');
            const question = input.value.trim();

            if (!question) {
                showToast('Please enter a question first', 'error');
                return;
            }

            // Disable input
            input.disabled = true;
            document.getElementById('sendBtn').disabled = true;

            // Add user message
            addUserMessage(question);
            input.value = '';
            input.style.height = 'auto';

            // Show typing indicator
            const typingId = addTypingIndicator();
            updateStatus('processing');

            // Send to /ask-all endpoint
            fetch(`${API_BASE}/ask-all`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question: question })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => Promise.reject(new Error(err.error || `HTTP ${response.status}`)));
                }
                return response.json();
            })
            .then(data => {
                removeTypingIndicator(typingId);
                if (data.error) {
                    addErrorMessage(data.error || 'Failed to retrieve all sources');
                    updateStatus('ready');
                    showToast('✗ Request failed', 'error');
                } else if (data.results || data.json || data.cloud_llm || data.local_llm) {
                    // Display all three sources in a structured format
                    addAllSourcesMessage(data, question);
                    updateStatus('ready');
                    showToast('✓ All sources retrieved', 'success');
                } else {
                    addErrorMessage('No sources returned');
                    updateStatus('ready');
                    showToast('✗ Request failed', 'error');
                }
            })
            .catch(error => {
                removeTypingIndicator(typingId);
                addErrorMessage(error.message || 'Failed to process request');
                updateStatus('ready');
                showToast('✗ Request failed', 'error');
            })
            .finally(() => {
                input.disabled = false;
                document.getElementById('sendBtn').disabled = false;
                input.focus();
            });
        }

        function addAllSourcesMessage(data, question) {
            const time = getCurrentTime();
            const results = data.results || data;
            
            const sources = [
                { key: 'json', label: 'JSON Database', icon: 'ri-database-2-fill', color: '#00d4aa', result: results.json || null },
                { key: 'cloud_llm', label: 'Cloud LLM', icon: 'ri-cloud-fill', color: '#ff006e', result: results.cloud_llm || null },
                { key: 'local_llm', label: 'Local LLM', icon: 'ri-cpu-fill', color: '#b026ff', result: results.local_llm || null }
            ];

            let sourcesHtml = '<div class="ultimate-grid">';
            
            sources.forEach(source => {
                const result = source.result;
                const status = result?.status === 'success' ? '✓ ACTIVE' : '✗ ERROR';
                const statusClass = result?.status === 'success' ? 'status-success' : 'status-error';
                const answer = result?.answer || 'No response';
                const latency = result?.latency_ms ? `${Math.round(result.latency_ms)}ms` : 'N/A';
                const model = result?.model_used || 'N/A';

                sourcesHtml += `
                    <div class="ultimate-card" style="border-top: 3px solid ${source.color};">
                        <div class="ultimate-header">
                            <div class="ultimate-title">
                                <i class="${source.icon}" style="color: ${source.color};"></i>
                                ${source.label}
                            </div>
                            <span class="ultimate-status ${statusClass}">${status}</span>
                        </div>
                        <div class="ultimate-meta">
                            <span><i class="ri-cpu-line"></i> ${model}</span>
                            <span><i class="ri-time-line"></i> ${latency}</span>
                        </div>
                        <div class="ultimate-content">
                            ${formatResponse(answer)}
                        </div>
                    </div>
                `;
            });
            
            sourcesHtml += '</div>';

            const html = `
                <div class="message">
                    <div class="message-header">
                        <div class="message-avatar ai">
                            <i class="ri-shield-check-fill"></i>
                        </div>
                        <div class="message-meta">
                            <span class="message-sender">CyberSentry</span>
                            <span class="message-time">${time}</span>
                            <span class="message-badge badge-ai">ULTIMATE MODE</span>
                        </div>
                    </div>
                    <div class="message-content ai ultimate-mode">
                        <div class="report-header">
                            <div class="report-title">
                                <i class="ri-layout-grid-fill"></i> Multi-Source Intelligence Report
                            </div>
                            <div class="report-meta">
                                <span>${time}</span>
                                <span>•</span>
                                <span>3 Sources</span>
                            </div>
                        </div>
                        <div class="report-body">
                            ${sourcesHtml}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('messagesArea').appendChild(createElementFromHTML(html));
            scrollToBottom();
        }

        // Add streaming-style loading for better UX
        function addUltimateLoadingMessage() {
            const time = getCurrentTime();
            const id = 'ultimate-loading-' + Date.now();
            
            const html = `
                <div class="message" id="${id}">
                    <div class="message-header">
                        <div class="message-avatar ai">
                            <i class="ri-shield-check-fill"></i>
                        </div>
                        <div class="message-meta">
                            <span class="message-sender">CyberSentry</span>
                            <span class="message-time">${time}</span>
                            <span class="message-badge badge-ai">PROCESSING</span>
                        </div>
                    </div>
                    <div class="message-content ai ultimate-mode">
                        <div class="ultimate-grid">
                            <div class="ultimate-card">
                                <div class="ultimate-header">
                                    <div class="ultimate-title">
                                        <i class="ri-database-2-fill" style="color: #00d4aa;"></i>
                                        JSON Database
                                    </div>
                                    <span class="ultimate-status" style="background: rgba(0, 212, 170, 0.15); color: #00d4aa;">
                                        <i class="ri-loader-4-line ri-spin"></i>
                                    </span>
                                </div>
                                <div class="ultimate-loading">
                                    <i class="ri-loader-4-line ri-spin"></i>
                                </div>
                            </div>
                            <div class="ultimate-card">
                                <div class="ultimate-header">
                                    <div class="ultimate-title">
                                        <i class="ri-cloud-fill" style="color: #ff006e;"></i>
                                        Cloud LLM
                                    </div>
                                    <span class="ultimate-status" style="background: rgba(255, 0, 110, 0.15); color: #ff006e;">
                                        <i class="ri-loader-4-line ri-spin"></i>
                                    </span>
                                </div>
                                <div class="ultimate-loading">
                                    <i class="ri-loader-4-line ri-spin"></i>
                                </div>
                            </div>
                            <div class="ultimate-card">
                                <div class="ultimate-header">
                                    <div class="ultimate-title">
                                        <i class="ri-cpu-fill" style="color: #b026ff;"></i>
                                        Local LLM
                                    </div>
                                    <span class="ultimate-status" style="background: rgba(176, 38, 255, 0.15); color: #b026ff;">
                                        <i class="ri-loader-4-line ri-spin"></i>
                                    </span>
                                </div>
                                <div class="ultimate-loading">
                                    <i class="ri-loader-4-line ri-spin"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('messagesArea').appendChild(createElementFromHTML(html));
            scrollToBottom();
            return id;
        }

        function compareAllSources() {
            const input = document.getElementById('userInput');
            const question = input.value.trim();
            
            if (!question) {
                showToast('⚠ Please enter a question', 'error');
                return;
            }
            
            // Disable inputs
            input.disabled = true;
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('compareBtn').disabled = true;
            
            // Add user message
            addUserMessage(question);
            input.value = '';
            input.style.height = 'auto';
            
            // Show ULTIMATE loading indicator
            const loadingId = addUltimateLoadingMessage();
            updateStatus('comparing sources');
            
            // Fetch from all sources
            fetch(`${API_BASE}/ask-all`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question: question })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => Promise.reject(new Error(err.error || `HTTP ${response.status}`)));
                }
                return response.json();
            })
            .then(data => {
                const loader = document.getElementById(loadingId);
                if (loader) loader.remove();
                
                if (data.error) {
                    addErrorMessage(data.error || 'Failed to compare sources');
                    updateStatus('ready');
                    showToast('✗ Comparison failed', 'error');
                } else {
                    // Use the new Ultimate Mode display
                    addAllSourcesMessage(data, question);
                    updateStatus('ready');
                    showToast('✓ Comparison complete', 'success');
                }
            })
            .catch(error => {
                const loader = document.getElementById(loadingId);
                if (loader) loader.remove();
                
                addErrorMessage(error.message || 'Failed to compare sources');
                updateStatus('ready');
                showToast('✗ Comparison failed', 'error');
            })
            .finally(() => {
                input.disabled = false;
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('compareBtn').disabled = false;
                input.focus();
            });
        }
        
        function addComparisonMessage(data, question) {
            const time = getCurrentTime();
            // /ask-all returns data.results with json, cloud_llm, local_llm inside
            const results = data.results || {
                json: data.json || null,
                cloud_llm: data.cloud_llm || null,
                local_llm: data.local_llm || null
            };
            
            const html = `
                <div class="message">
                    <div class="message-header">
                        <div class="message-avatar ai">
                            <i class="ri-layout-column-fill"></i>
                        </div>
                        <div class="message-meta">
                            <span class="message-sender">Source Comparison</span>
                            <span class="message-time">${time}</span>
                            <span class="message-badge badge-ai">COMPARE</span>
                        </div>
                    </div>
                    <div class="message-content ai">
                        <div class="comparison-container">
                            ${createSourceColumn(results.json, 'json-source', 'JSON Database', 'ri-database-2-fill')}
                            ${createSourceColumn(results.cloud_llm, 'cloud-llm', 'Cloud LLM', 'ri-cloud-fill')}
                            ${createSourceColumn(results.local_llm, 'local-llm', 'Local LLM', 'ri-cpu-fill')}
                        </div>
                        <div class="card-actions">
                            <button class="action-btn" data-action="copy" data-text="${escapeHtml(JSON.stringify(results, null, 2))}">
                                <i class="ri-file-copy-line"></i> Copy All Results
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('messagesArea').appendChild(createElementFromHTML(html));
            scrollToBottom();
        }
        
        function createSourceColumn(result, className, title, icon) {
            if (!result) {
                return `
                    <div class="source-column ${className}">
                        <div class="source-header">
                            <i class="${icon}"></i>
                            <h3>${title}</h3>
                            <span class="status-badge status-error">UNAVAILABLE</span>
                        </div>
                        <div class="source-content">
                            <p style="color: var(--text-tertiary);">No response available</p>
                        </div>
                    </div>
                `;
            }
            
            const isSuccess = result.status === 'success';
            const statusClass = isSuccess ? 'status-success' : 'status-error';
            const statusText = isSuccess ? 'ACTIVE' : (result.status ? result.status.toUpperCase() : 'ERROR');
            
            let contentHtml = '';
            if (isSuccess && result.answer) {
                contentHtml = formatResponse(result.answer);
            } else {
                contentHtml = `<span style="color: var(--text-tertiary);">${result.answer || 'No response'}</span>`;
            }
            
            const latency = result.latency_ms ? Math.round(result.latency_ms) : (result.latency ? result.latency : null);
            const metaHtml = latency ? 
                `<div class="source-meta">
                    <div class="meta-item">
                        <i class="ri-time-line"></i>
                        ${latency}ms
                    </div>
                    <div class="meta-item">
                        <i class="ri-cpu-line"></i>
                        ${result.model_used || 'N/A'}
                    </div>
                </div>` : '';
            
            return `
                <div class="source-column ${className}">
                    <div class="source-header">
                        <div class="source-title">
                            <div class="source-icon">
                                <i class="${icon}"></i>
                            </div>
                            ${title}
                        </div>
                        <div class="source-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="source-content">${contentHtml}</div>
                    ${metaHtml}
                </div>
            `;
        }

        // Enhanced Export with Logo and Proper Formatting
        function exportConversation(format = 'json') {
            const messages = document.querySelectorAll('.message');
            const conversation = [];
            
            messages.forEach(msg => {
                const sender = msg.querySelector('.message-sender')?.textContent;
                const time = msg.querySelector('.message-time')?.textContent;
                
                // Try to get text from different possible locations
                let text = msg.querySelector('.message-text')?.textContent;
                if (!text) {
                    text = msg.querySelector('.report-body')?.textContent;
                }
                if (!text) {
                    text = msg.querySelector('.ultimate-content')?.textContent;
                }
                if (!text) {
                    text = msg.querySelector('.message-content')?.textContent;
                }
                
                const source = msg.querySelector('.message-badge')?.textContent;
                
                if (sender && text) {
                    conversation.push({
                        sender,
                        time,
                        text: text.trim(),
                        source: source || 'N/A'
                    });
                }
            });
            
            if (conversation.length === 0) {
                showToast('⚠ No conversation to export', 'error');
                return;
            }
            
            let content, filename, mimeType;
            
            if (format === 'json') {
                content = JSON.stringify({
                    app: 'CyberSentry AI',
                    version: 'v4.5',
                    exported: new Date().toISOString(),
                    total_messages: conversation.length,
                    conversation: conversation
                }, null, 2);
                filename = `cybersentry_conversation_${Date.now()}.json`;
                mimeType = 'application/json';
            } else if (format === 'txt') {
                content = generateTextExport(conversation);
                filename = `cybersentry_conversation_${Date.now()}.txt`;
                mimeType = 'text/plain';
            } else if (format === 'md') {
                content = generateMarkdownExport(conversation);
                filename = `cybersentry_conversation_${Date.now()}.md`;
                mimeType = 'text/markdown';
            } else if (format === 'pdf') {
                exportToPDF(conversation);
                return;
            }
            
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast(`✓ Exported as ${format.toUpperCase()}`, 'success');
        }

        function generateTextExport(conversation) {
            const header = `
═══════════════════════════════════════════════════════════════════════════
    ██████╗██╗   ██╗██████╗ ███████╗██████╗ ███████╗███████╗███╗   ██╗████████╗██████╗ ██╗   ██╗
   ██╔════╝╚██╗ ██╔╝██╔══██╗██╔════╝██╔══██╗██╔════╝██╔════╝████╗  ██║╚══██╔══╝██╔══██╗╚██╗ ██╔╝
   ██║      ╚████╔╝ ██████╔╝█████╗  ██████╔╝███████╗█████╗  ██╔██╗ ██║   ██║   ██████╔╝ ╚████╔╝ 
   ██║       ╚██╔╝  ██╔══██╗██╔══╝  ██╔══██╗╚════██║██╔══╝  ██║╚██╗██║   ██║   ██╔══██╗  ╚██╔╝  
   ╚██████╗   ██║   ██████╔╝███████╗██║  ██║███████║███████╗██║ ╚████║   ██║   ██║  ██║   ██║   
    ╚═════╝   ╚═╝   ╚═════╝ ╚══════╝╚═╝  ╚═╝╚══════╝╚══════╝╚═╝  ╚═══╝   ╚═╝   ╚═╝  ╚═╝   ╚═╝   
                                                                                    
                              🛡️  ADVANCED CYBERSECURITY AI ASSISTANT  🛡️
═══════════════════════════════════════════════════════════════════════════

CONVERSATION REPORT
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 Report Information:
   • Generated: ${new Date().toLocaleString()}
   • Total Messages: ${conversation.length}
   • Version: v4.5
   • Export Format: TXT

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

CONVERSATION TRANSCRIPT
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

`;
            
            let content = header;
            
            conversation.forEach((msg, index) => {
                const icon = msg.sender === 'You' ? '👤' : '🤖';
                const separator = '─'.repeat(75);
                
                content += `
${separator}
${icon} ${msg.sender.toUpperCase()} | ${msg.time} | Source: ${msg.source}
${separator}

${formatTextContent(msg.text)}

`;
            });
            
            const footer = `
═══════════════════════════════════════════════════════════════════════════
                         END OF CONVERSATION REPORT
                    Generated by CyberSentry AI v4.5
                         © ${new Date().getFullYear()} - All Rights Reserved
═══════════════════════════════════════════════════════════════════════════
`;
            
            content += footer;
            return content;
        }

        function generateMarkdownExport(conversation) {
            const content = `
# 🛡️ CyberSentry AI - Conversation Report

![CyberSentry AI](https://img.shields.io/badge/CyberSentry-AI%20v4.5-00f0ff?style=for-the-badge&logo=security&logoColor=white)
![Status](https://img.shields.io/badge/Status-Active-00d4aa?style=for-the-badge)
![Export](https://img.shields.io/badge/Export-Markdown-ff006e?style=for-the-badge)

---

## 📊 Report Information

| Field | Value |
|-------|-------|
| **Generated** | ${new Date().toLocaleString()} |
| **Total Messages** | ${conversation.length} |
| **Version** | v4.5 |
| **Format** | Markdown |

---

## 💬 Conversation Transcript

${conversation.map((msg, index) => {
    const icon = msg.sender === 'You' ? '👤' : '🤖';
    return `
### ${icon} **${msg.sender}** <small>*${msg.time}*</small>

> **Source:** ${msg.source}

${formatMarkdownContent(msg.text)}

---
`;
}).join('\n')}

---

## 🔒 Security Notice

This conversation may contain sensitive security information. Please handle with care and follow your organization's data security policies.

---

<div align="center">

**CyberSentry AI v4.5**  
*Advanced Cybersecurity Assistant*

Generated on ${new Date().toLocaleString()}

</div>
`;
            
            return content;
        }

        function formatTextContent(text) {
            // Clean up text content for TXT export
            let cleaned = text.replace(/\n{3,}/g, '\n\n'); // Remove excessive newlines
            cleaned = cleaned.replace(/\s{2,}/g, ' '); // Remove excessive spaces
            cleaned = cleaned.trim();
            
            // Wrap long lines
            const lines = cleaned.split('\n');
            const wrapped = lines.map(line => {
                if (line.length > 75) {
                    return wrapText(line, 75);
                }
                return line;
            }).join('\n');
            
            return wrapped;
        }

        function formatMarkdownContent(text) {
            // Clean up and format for Markdown
            let formatted = text.trim();
            
            // Preserve code blocks
            formatted = formatted.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                return '```' + (lang || '') + '\n' + code.trim() + '\n```';
            });
            
            // Format lists
            formatted = formatted.replace(/^[•▸]\s+/gm, '- ');
            
            // Clean up excessive whitespace
            formatted = formatted.replace(/\n{3,}/g, '\n\n');
            
            return formatted;
        }

        function wrapText(text, maxLength) {
            const words = text.split(' ');
            const lines = [];
            let currentLine = '';
            
            words.forEach(word => {
                if ((currentLine + word).length > maxLength) {
                    lines.push(currentLine.trim());
                    currentLine = word + ' ';
                } else {
                    currentLine += word + ' ';
                }
            });
            
            if (currentLine) {
                lines.push(currentLine.trim());
            }
            
            return lines.join('\n');
        }

        function exportToPDF(conversation) {
            const htmlContent = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberSentry AI - Conversation Report</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #1a1a1a;
            background: #ffffff;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #0a0e12 0%, #1a2129 100%);
            color: #00f0ff;
            padding: 40px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }
        
        .logo {
            font-size: 48px;
            font-weight: 800;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(0, 240, 255, 0.5);
        }
        
        .subtitle {
            font-size: 18px;
            color: #a0aab8;
            margin-bottom: 20px;
        }
        
        .report-info {
            background: #f8f9fa;
            border-left: 4px solid #00f0ff;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
        }
        
        .report-info h2 {
            color: #0a0e12;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-label {
            font-weight: 600;
            color: #495057;
        }
        
        .info-value {
            color: #212529;
        }
        
        .message-container {
            margin-bottom: 30px;
            page-break-inside: avoid;
        }
        
        .message {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .message-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f3f5;
        }
        
        .sender {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 18px;
            color: #212529;
        }
        
        .sender-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .user-icon {
            background: linear-gradient(135deg, #b026ff, #9b7ee0);
            color: white;
        }
        
        .ai-icon {
            background: linear-gradient(135deg, #00f0ff, #00d4aa);
            color: #0a0e12;
        }
        
        .message-meta {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
            color: #6c757d;
        }
        
        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge-user {
            background: rgba(176, 38, 255, 0.15);
            color: #b026ff;
            border: 1px solid rgba(176, 38, 255, 0.3);
        }
        
        .badge-ai {
            background: rgba(0, 240, 255, 0.15);
            color: #00f0ff;
            border: 1px solid rgba(0, 240, 255, 0.3);
        }
        
        .badge-json {
            background: rgba(0, 212, 170, 0.15);
            color: #00d4aa;
            border: 1px solid rgba(0, 212, 170, 0.3);
        }
        
        .message-content {
            color: #212529;
            font-size: 15px;
            line-height: 1.8;
        }
        
        .message-content strong {
            color: #00f0ff;
            font-weight: 700;
        }
        
        .message-content code {
            background: #f8f9fa;
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #00f0ff;
            border: 1px solid #e9ecef;
        }
        
        /* Code block styles consolidated above with .code-box - using unified styling */
        
        .footer {
            margin-top: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #0a0e12 0%, #1a2129 100%);
            color: #a0aab8;
            text-align: center;
            border-radius: 12px;
        }
        
        .footer-title {
            font-size: 24px;
            font-weight: 700;
            color: #00f0ff;
            margin-bottom: 10px;
        }
        
        .footer-subtitle {
            font-size: 14px;
            color: #6c757d;
        }

        /* Section dividers */
        hr {
            border: none;
            height: 1px;
            background: linear-gradient(to right, transparent, #00ffe1, transparent);
            margin: 64px 0;
        }
        
        @media print {
            body {
                padding: 0;
            }
            
            .message-container {
                page-break-inside: avoid;
            }
            
            @page {
                margin: 2cm;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">🛡️ CYBERSENTRY AI</div>
        <div class="subtitle">Advanced Cybersecurity Assistant • Version 4.5</div>
    </div>
    
    <div class="report-info">
        <h2>📊 Conversation Report</h2>
        <div class="info-grid">
            <div class="info-item">
                <span class="info-label">Generated:</span>
                <span class="info-value">${new Date().toLocaleString()}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Total Messages:</span>
                <span class="info-value">${conversation.length}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Version:</span>
                <span class="info-value">v4.5</span>
            </div>
            <div class="info-item">
                <span class="info-label">Export Format:</span>
                <span class="info-value">PDF</span>
            </div>
        </div>
    </div>
    
    <div class="message-container">
        ${conversation.map((msg, index) => {
            const isUser = msg.sender === 'You';
            const icon = isUser ? '👤' : '🤖';
            const iconClass = isUser ? 'user-icon' : 'ai-icon';
            const badgeClass = isUser ? 'badge-user' : (msg.source === 'JSON' ? 'badge-json' : 'badge-ai');
            
            return `
                <div class="message">
                    <div class="message-header">
                        <div class="sender">
                            <div class="sender-icon ${iconClass}">${icon}</div>
                            ${msg.sender}
                        </div>
                        <div class="message-meta">
                            <span>${msg.time}</span>
                            <span class="badge ${badgeClass}">${msg.source}</span>
                        </div>
                    </div>
                    <div class="message-content">
                        ${formatHTMLContent(msg.text)}
                    </div>
                </div>
            `;
        }).join('')}
    </div>
    
    <div class="footer">
        <div class="footer-title">CyberSentry AI v4.5</div>
        <div class="footer-subtitle">© ${new Date().getFullYear()} - Advanced Cybersecurity Assistant</div>
        <div class="footer-subtitle">Generated on ${new Date().toLocaleString()}</div>
    </div>
</body>
</html>
    `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            
            printWindow.onload = () => {
                printWindow.focus();
                setTimeout(() => {
                    printWindow.print();
                    showToast('✓ PDF export initiated - Use Print dialog to save', 'success');
                }, 500);
            };
        }

        function formatHTMLContent(text) {
            let formatted = escapeHtml(text);
            
            // Convert **bold** to <strong>
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Convert code blocks
            formatted = formatted.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                return `<pre><code>${code.trim()}</code></pre>`;
            });
            
            // Convert inline code
            formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Convert line breaks
            formatted = formatted.replace(/\n/g, '<br>');
            
            return formatted;
        }
        
        // Share conversation
        async function shareConversation() {
            const messages = document.querySelectorAll('.message');
            let shareText = 'CyberSentry AI Conversation:\n\n';
            
            messages.forEach(msg => {
                const sender = msg.querySelector('.message-sender')?.textContent;
                const text = msg.querySelector('.message-text')?.textContent;
                if (sender && text) {
                    shareText += `${sender}: ${text.trim().substring(0, 100)}...\n\n`;
                }
            });
            
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'CyberSentry AI Conversation',
                        text: shareText
                    });
                    showToast('✓ Shared successfully', 'success');
                } catch (e) {
                    console.log('Share cancelled');
                }
            } else {
                // Fallback: copy to clipboard
                await navigator.clipboard.writeText(shareText);
                showToast('✓ Copied to clipboard', 'success');
            }
        }

        function showToast(message, type = 'success') {
            // Remove existing toasts
            const existing = document.querySelectorAll('.toast');
            existing.forEach(t => t.remove());

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="ri-${type === 'success' ? 'check' : 'error-warning'}-line"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Theme toggle
        function toggleTheme() {
            const body = document.body;
            const icon = document.querySelector('#themeToggle i');
            
            if (body.classList.contains('light-mode')) {
                body.classList.remove('light-mode');
                localStorage.setItem('theme', 'dark');
                showToast('🌙 Dark mode enabled', 'success');
            } else {
                body.classList.add('light-mode');
                localStorage.setItem('theme', 'light');
                showToast('☀️ Light mode enabled', 'success');
            }
        }
        
        // Sidebar toggle
        function toggleSidebar() {
            document.querySelector('.app-container').classList.toggle('sidebar-collapsed');
        }
        
        // New chat
        function startNewChat() {
            if (confirm('Start a new conversation? Current chat will be saved.')) {
                // Save current conversation
                saveConversationToHistory();
                
                // Clear messages except welcome
                const messagesArea = document.getElementById('messagesArea');
                messagesArea.innerHTML = '';
                
                // Reinitialize
                initializeApp();
                displayWelcomeTime();
                
                showToast('✓ New conversation started', 'success');
            }
        }
        
        // Voice input
        let recognition = null;
        let isRecording = false;
        
        function toggleVoiceInput() {
            const voiceBtn = document.getElementById('voiceBtn');
            
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showToast('⚠ Voice input not supported', 'error');
                return;
            }
            
            if (isRecording) {
                recognition.stop();
                isRecording = false;
                voiceBtn.classList.remove('recording');
                return;
            }
            
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'en-US';
            recognition.continuous = false;
            recognition.interimResults = false;
            
            recognition.onstart = () => {
                isRecording = true;
                voiceBtn.classList.add('recording');
                showToast('🎤 Listening...', 'success');
            };
            
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('userInput').value = transcript;
                showToast('✓ Voice captured', 'success');
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                showToast('✗ Voice input failed', 'error');
                isRecording = false;
                voiceBtn.classList.remove('recording');
            };
            
            recognition.onend = () => {
                isRecording = false;
                voiceBtn.classList.remove('recording');
            };
            
            recognition.start();
        }
        
        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        // Close modal on backdrop click
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });
        
        // Shortcuts panel
        function toggleShortcuts() {
            const panel = document.getElementById('shortcutsPanel');
            if (panel) {
                panel.classList.toggle('active');
            }
        }
        
        // Settings
        function loadSettings() {
            const theme = localStorage.getItem('theme') || 'dark';
            if (theme === 'light') {
                document.body.classList.add('light-mode');
            }
            
            const fontSize = localStorage.getItem('fontSize') || '14';
            document.documentElement.style.fontSize = fontSize + 'px';
            
            const preferredSource = localStorage.getItem('preferredSource') || 'auto';
            // Apply preferred source logic...
        }
        
        function saveSettings() {
            const themeSelect = document.getElementById('themeSelect');
            const fontSizeRange = document.getElementById('fontSizeRange');
            const preferredSource = document.getElementById('preferredSource');
            const responseLength = document.getElementById('responseLength');
            
            if (themeSelect) {
                const theme = themeSelect.value;
                localStorage.setItem('theme', theme);
                if (theme === 'light') {
                    document.body.classList.add('light-mode');
                } else {
                    document.body.classList.remove('light-mode');
                }
            }
            
            if (fontSizeRange) {
                const fontSize = fontSizeRange.value;
                localStorage.setItem('fontSize', fontSize);
                document.documentElement.style.fontSize = fontSize + 'px';
            }
            
            if (preferredSource) {
                localStorage.setItem('preferredSource', preferredSource.value);
            }
            
            if (responseLength) {
                localStorage.setItem('responseLength', responseLength.value);
            }
            
            const settingsModal = document.getElementById('settingsModal');
            if (settingsModal) {
                closeModal('settingsModal');
            }
            showToast('✓ Settings saved', 'success');
        }
        
        function clearAllData() {
            if (confirm('Clear all conversations and settings? This cannot be undone.')) {
                localStorage.clear();
                sessionStorage.clear();
                location.reload();
            }
        }
        
        // Conversation history
        function loadConversationHistory() {
            const history = JSON.parse(localStorage.getItem('conversationHistory') || '[]');
            const listEl = document.getElementById('conversationList');
            
            if (!listEl) return;
            if (history.length === 0) {
                listEl.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-tertiary); font-size: 0.875rem;">No conversations yet</div>';
                return;
            }
            
            listEl.innerHTML = history.map((conv, index) => `
                <div class="conversation-item" onclick="loadConversation(${index})">
                    <div class="conversation-title">${conv.title || 'Untitled Conversation'}</div>
                    <div class="conversation-meta">
                        <span>${conv.messageCount || 0} messages</span>
                        <span>•</span>
                        <span>${formatTimestamp(conv.timestamp)}</span>
                    </div>
                </div>
            `).join('');
        }
        
        function saveConversationToHistory() {
            const messages = Array.from(document.querySelectorAll('.message')).map(msg => {
                let text = msg.querySelector('.message-text')?.textContent || '';
                if (!text) {
                    text = msg.querySelector('.report-body')?.textContent || '';
                }
                if (!text) {
                    text = msg.querySelector('.message-content')?.textContent || '';
                }
                return {
                    sender: msg.querySelector('.message-sender')?.textContent || '',
                    text: text,
                    time: msg.querySelector('.message-time')?.textContent || '',
                    source: msg.querySelector('.message-badge')?.textContent || ''
                };
            });
            
            if (messages.length <= 1) return; // Don't save if only welcome message
            
            const history = JSON.parse(localStorage.getItem('conversationHistory') || '[]');
            const firstUserMessage = messages.find(m => m.sender === 'You');
            
            history.unshift({
                title: firstUserMessage?.text.substring(0, 50) + '...' || 'Untitled',
                timestamp: Date.now(),
                messageCount: messages.length,
                messages: messages
            });
            
            // Keep only last 50 conversations
            if (history.length > 50) {
                history.pop();
            }
            
            localStorage.setItem('conversationHistory', JSON.stringify(history));
            loadConversationHistory();
        }
        
        function loadConversation(index) {
            const history = JSON.parse(localStorage.getItem('conversationHistory') || '[]');
            const conv = history[index];
            
            if (!conv) return;
            
            // Clear current messages
            const messagesArea = document.getElementById('messagesArea');
            messagesArea.innerHTML = '';
            
            // Load conversation messages
            conv.messages.forEach(msg => {
                if (msg.sender === 'You') {
                    addUserMessage(msg.text);
                } else if (msg.sender === 'CyberSentry AI') {
                    addAIMessage({
                        answer: msg.text,
                        source: msg.source,
                        can_regenerate: false,
                        model_used: 'archived'
                    }, '');
                }
            });
            
            // Highlight active conversation
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll('.conversation-item')[index]?.classList.add('active');
            
            showToast('✓ Conversation loaded', 'success');
        }
        
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
            if (diff < 604800000) return Math.floor(diff / 86400000) + 'd ago';
            
            return date.toLocaleDateString();
        }
        
        // Advanced search
        function performAdvancedSearch() {
            const query = document.getElementById('advancedSearchQuery').value.trim();
            const sourceFilter = document.getElementById('sourceFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            if (!query) {
                showToast('⚠ Please enter a search query', 'error');
                return;
            }
            
            // Search in current conversation
            const messages = document.querySelectorAll('.message');
            let results = [];
            
            messages.forEach(msg => {
                const text = msg.querySelector('.message-text')?.textContent.toLowerCase() || '';
                const source = msg.querySelector('.message-badge')?.textContent || '';
                const time = msg.querySelector('.message-time')?.textContent || '';
                
                if (text.includes(query.toLowerCase())) {
                    if (sourceFilter === 'all' || source === sourceFilter) {
                        results.push({ msg, text, source, time });
                    }
                }
            });
            
            if (results.length === 0) {
                showToast('⚠ No results found', 'error');
            } else {
                // Highlight results
                results.forEach(result => {
                    result.msg.style.border = '2px solid var(--accent-primary)';
                    result.msg.scrollIntoView({ behavior: 'smooth', block: 'center' });
                });
                
                showToast(`✓ Found ${results.length} result(s)`, 'success');
                
                // Clear highlights after 3 seconds
                setTimeout(() => {
                    results.forEach(result => {
                        result.msg.style.border = '';
                    });
                }, 3000);
            }
            
            closeModal('searchModal');
        }
        
        
        
        // Smart suggestions
        const commonQuestions = [
            {
                icon: 'ri-search-eye-line',
                title: 'Port Scanning',
                description: 'How to scan ports with Nmap',
                query: 'How do I perform a comprehensive port scan using Nmap?'
            },
            {
                icon: 'ri-spy-line',
                title: 'SQL Injection',
                description: 'Detect SQL injection vulnerabilities',
                query: 'How can I detect and prevent SQL injection attacks?'
            },
            {
                icon: 'ri-shield-cross-line',
                title: 'XSS Protection',
                description: 'Prevent cross-site scripting',
                query: 'What are best practices for preventing XSS attacks?'
            },
            {
                icon: 'ri-lock-password-line',
                title: 'Password Security',
                description: 'Secure password hashing',
                query: 'What are the best password hashing algorithms in 2025?'
            },
            {
                icon: 'ri-bug-line',
                title: 'Vulnerability Assessment',
                description: 'Scan for vulnerabilities',
                query: 'How do I conduct a comprehensive vulnerability assessment?'
            },
            {
                icon: 'ri-terminal-box-line',
                title: 'Penetration Testing',
                description: 'Pen testing methodology',
                query: 'What is the standard penetration testing methodology?'
            }
        ];
        
        // Show suggestions on focus
        document.getElementById('userInput').addEventListener('focus', () => {
            const input = document.getElementById('userInput');
            if (input.value.trim() === '') {
                showSuggestions();
            }
        });
        
        function showSuggestions() {
            const panel = document.getElementById('suggestionsPanel');
            const list = document.getElementById('suggestionsList');
            
            if (!panel || !list) {
                console.warn('Suggestions panel or list not found');
                return;
            }
            
            list.innerHTML = commonQuestions.map(q => `
                <div class="suggestion-item" onclick="applySuggestion('${escapeHtml(q.query)}')">
                    <div class="suggestion-icon">
                        <i class="${q.icon}"></i>
                    </div>
                    <div class="suggestion-content">
                        <div class="suggestion-title">${q.title}</div>
                        <div class="suggestion-description">${q.description}</div>
                    </div>
                </div>
            `).join('');
            
            panel.classList.add('active');
        }
        
        function applySuggestion(query) {
            const input = document.getElementById('userInput');
            const panel = document.getElementById('suggestionsPanel');
            if (input) {
                input.value = query;
                input.focus();
            }
            if (panel) {
                panel.classList.remove('active');
            }
        }
        
        // Hide suggestions when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.input-area')) {
                document.getElementById('suggestionsPanel').classList.remove('active');
            }
        });
        
        // Font size range slider
        document.getElementById('fontSizeRange')?.addEventListener('input', (e) => {
            document.getElementById('fontSizeValue').textContent = e.target.value + 'px';
        });
        
        // Auto-save conversation on new message
        let autoSaveTimeout;
        const originalAddAIMessage = addAIMessage;
        addAIMessage = function(...args) {
            originalAddAIMessage.apply(this, args);
            
            // Auto-save after 2 seconds of inactivity
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                saveConversationToHistory();
            }, 2000);
        };
        
        // Code execution removed - keeping copy functionality only
        
        function executeCode(code, language, button) {
            button.disabled = true;
            button.innerHTML = '<i class="ri-loader-4-line ri-spin"></i> Running...';
            
            fetch(`${API_BASE}/execute-code`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code, language })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => Promise.reject(new Error(err.error || `HTTP ${response.status}`)));
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showCodeOutput(data.output, button);
                    showToast('✓ Code executed', 'success');
                } else {
                    showCodeOutput(data.output || data.error || 'Execution failed', button, true);
                    showToast('✗ Execution failed', 'error');
                }
            })
            .catch(error => {
                showCodeOutput(error.message, button, true);
                showToast('✗ Execution error', 'error');
            })
            .finally(() => {
                button.disabled = false;
                button.innerHTML = '<i class="ri-play-line"></i> Run';
            });
        }
        
        function showCodeOutput(output, button, isError = false) {
            const pre = button.closest('pre');
            if (!pre) {
                console.warn('Pre element not found for code output');
                return;
            }
            let outputEl = pre.nextElementSibling;
            
            if (!outputEl || !outputEl.classList.contains('code-output')) {
                outputEl = document.createElement('div');
                outputEl.className = 'code-output';
                pre.parentNode.insertBefore(outputEl, pre.nextSibling);
            }
            
            outputEl.innerHTML = `
                <div class="output-header">
                    <span><i class="ri-terminal-line"></i> Output</span>
                    <button class="copy-output-btn" onclick="copyOutput(this)">
                        <i class="ri-file-copy-line"></i>
                    </button>
                </div>
                <pre class="${isError ? 'error' : ''}">${escapeHtml(output)}</pre>
            `;
        }
        
        function copyOutput(button) {
            const output = button.closest('.code-output').querySelector('pre').textContent;
            navigator.clipboard.writeText(output).then(() => {
                showToast('✓ Output copied', 'success');
            });
        }
        
        // Add copy buttons to code blocks
        function enhanceCodeBlocks() {
            document.querySelectorAll('pre code').forEach(block => {
                const pre = block.closest('pre');
                if (!pre || pre.querySelector('.code-copy-btn')) return;
                
                const copyBtn = document.createElement('button');
                copyBtn.className = 'code-copy-btn';
                copyBtn.innerHTML = '<i class="ri-file-copy-line"></i> Copy';
                copyBtn.title = 'Copy code';
                
                copyBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const codeText = block.textContent || block.innerText;
                    
                    navigator.clipboard.writeText(codeText).then(() => {
                        const originalHTML = copyBtn.innerHTML;
                        copyBtn.innerHTML = '<i class="ri-check-line"></i> Copied!';
                        copyBtn.classList.add('copied');
                        
                        setTimeout(() => {
                            copyBtn.innerHTML = originalHTML;
                            copyBtn.classList.remove('copied');
                        }, 2000);
                        
                        showToast('✓ Code copied to clipboard', 'success');
                    }).catch(() => {
                        showToast('✗ Failed to copy code', 'error');
                    });
                });
                
                pre.style.position = 'relative';
                pre.appendChild(copyBtn);
            });
        }
        
        // Enhance code blocks after each AI message
        const originalFormatResponse = formatResponse;
        formatResponse = function(text) {
            const result = originalFormatResponse(text);
            setTimeout(enhanceCodeBlocks, 100);
            return result;
        };
        
        // Real-time typing indicator for AI
        let typingTimeout;
        document.getElementById('userInput').addEventListener('input', () => {
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                // Could show "AI is preparing suggestions..." here
            }, 500);
        });
        
        // Markdown preview for input
        let previewTimeout;
        document.getElementById('userInput').addEventListener('input', (e) => {
            clearTimeout(previewTimeout);
            previewTimeout = setTimeout(() => {
                const text = e.target.value;
                if (text.includes('```') || text.includes('**')) {
                    // Show markdown preview hint
                    // Could add a small preview tooltip
                }
            }, 500);
        });
        
        // Network status monitoring
        window.addEventListener('online', () => {
            showToast('🌐 Back online', 'success');
            updateStatus('ready');
        });
        
        window.addEventListener('offline', () => {
            showToast('⚠ No internet connection', 'error');
            updateStatus('offline');
        });
        
        // Performance monitoring
        let lastRequestTime = Date.now();
        const originalSendMessage = sendMessage;
        sendMessage = function() {
            lastRequestTime = Date.now();
            originalSendMessage.apply(this, arguments);
        };
        
        // Show loading state improvements
        const enhancedUpdateStatus = updateStatus;
        updateStatus = function(status) {
            enhancedUpdateStatus(status);
            
            // Add performance metrics
            if (status === 'ready' && lastRequestTime) {
                const responseTime = Date.now() - lastRequestTime;
                if (responseTime > 5000) {
                    console.log(`Slow response: ${responseTime}ms`);
                }
            }
        };
        
        // Initialize all features
        document.addEventListener('DOMContentLoaded', () => {
            // Load saved theme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
            }
            
            // Check if first visit
            if (!localStorage.getItem('hasVisited')) {
                localStorage.setItem('hasVisited', 'true');
                setTimeout(() => {
                    showToast('💡 Press Ctrl+/ to see all shortcuts', 'success');
                }, 3000);
            }
            
            // Preload conversation history
            loadConversationHistory();
        });
    </script>
</body>
</html>
